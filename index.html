<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Integraci√≥n Rappi</title>
    <link rel="preconnect" href="https://rsms.me/" />
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css" />
    <style>
      /* Reset B√°sico y Estilos Globales */
      *,
      *::before,
      *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji",
          "Segoe UI Emoji", "Segoe UI Symbol";
        background-color: #f0f2f5;
        color: #1f2937; /* Gris oscuro para texto */
        line-height: 1.6;
        font-size: 16px;
        padding-bottom: 320px;
      }

      .container {
        max-width: 950px;
        margin: 2rem auto;
        padding: 2rem;
        background-color: #ffffff;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      }

      /* Encabezados */
      h1,
      h2,
      h3,
      h4 {
        margin-bottom: 0.75em;
        color: #111827;
        font-weight: 600;
      }
      h1 {
        font-size: 2em;
        text-align: center;
        color: #ef4444;
      }
      h2 {
        font-size: 1.5em;
        border-bottom: 1px solid #e5e7eb;
        padding-bottom: 0.3em;
      }
      h3 {
        font-size: 1.25em;
      }
      h4 {
        font-size: 1em;
      }

      /* Botones */
      .btn {
        display: inline-block;
        padding: 0.6em 1.2em;
        border: none;
        border-radius: 6px;
        font-size: 0.95em;
        font-weight: 500;
        text-align: center;
        text-decoration: none;
        cursor: pointer;
        transition: background-color 0.2s ease-in-out,
          box-shadow 0.2s ease-in-out, transform 0.1s ease;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .btn:hover {
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        transform: translateY(-1px);
      }
      .btn:active {
        transform: translateY(0px);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      }
      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: translateY(0px);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .btn-primary {
        background-color: #ef4444;
        color: white;
      }
      .btn-primary:hover:not(:disabled) {
        background-color: #dc2626;
      }

      .btn-secondary {
        background-color: #6b7280;
        color: white;
      }
      .btn-secondary:hover:not(:disabled) {
        background-color: #4b5563;
      }

      .btn-info {
        background-color: #3b82f6;
        color: white;
      }
      .btn-info:hover:not(:disabled) {
        background-color: #2563eb;
      }

      .btn-success {
        background-color: #10b981;
        color: white;
      }
      .btn-success:hover:not(:disabled) {
        background-color: #059669;
      }

      .btn-danger {
        background-color: #d9534f;
        color: white;
      }
      .btn-danger:hover:not(:disabled) {
        background-color: #c9302c;
      }

      .btn-warning {
        background-color: #f0ad4e;
        color: white;
      }
      .btn-warning:hover:not(:disabled) {
        background-color: #ec971f;
      }

      .btn-link {
        background: none;
        border: none;
        color: #3b82f6;
        cursor: pointer;
        text-decoration: none;
        padding: 0.2em 0.4em;
        font-size: 0.9em;
        border-radius: 4px;
        transition: background-color 0.2s ease;
      }
      .btn-link:hover {
        background-color: rgba(59, 130, 246, 0.1);
        text-decoration: underline;
      }
      .btn-link-danger {
        color: #d9534f;
      }
      .btn-link-danger:hover {
        background-color: rgba(217, 83, 79, 0.1);
      }

      .btn-copy {
        font-size: 0.75em;
        padding: 0.2em 0.5em;
        margin-left: 0.5rem;
        background-color: #e5e7eb;
        color: #4b5563;
        border: 1px solid #d1d5db;
      }
      .btn-copy:hover {
        background-color: #d1d5db;
      }

      /* Formularios */
      .form-group {
        margin-bottom: 1rem;
      }
      .form-group label {
        display: block;
        font-size: 0.9em;
        font-weight: 500;
        margin-bottom: 0.3rem;
        color: #374151;
      }
      .input-field,
      select.input-field,
      textarea.input-field {
        width: 100%;
        padding: 0.6em 0.8em;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 0.95em;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }
      .input-field:focus {
        outline: none;
        border-color: #ef4444;
        box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2);
      }
      textarea.input-field {
        min-height: 80px;
        resize: vertical;
      }
      .input-field-sm {
        padding: 0.3em 0.6em;
        font-size: 0.9em;
      }
      .search-input-group {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
        align-items: center;
      }
      .search-input-group .input-field {
        flex-grow: 1;
      }

      /* Cards */
      .card {
        background-color: #ffffff;
        border-radius: 8px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        margin-bottom: 1.5rem;
      }

      /* Modales */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.6);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        overflow-y: auto;
        padding: 1rem;
      }
      .modal-overlay.active {
        display: flex;
      }
      .modal-content {
        background-color: white;
        padding: 2rem;
        border-radius: 8px;
        width: 100%;
        max-width: 600px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        margin: auto;
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #e5e7eb;
      }
      .modal-header h3 {
        margin-bottom: 0;
      }
      .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
        margin-top: 1.5rem;
        padding-top: 1rem;
        border-top: 1px solid #e5e7eb;
      }
      .close-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #6b7280;
      }
      .close-btn:hover {
        color: #1f2937;
      }

      /* Tablas */
      .table-wrapper {
        overflow-x: auto;
      }
      .table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9em;
      }
      .table th,
      .table td {
        border: 1px solid #e5e7eb;
        padding: 0.6em 0.8em;
        text-align: left;
        vertical-align: top;
      }
      .table th {
        background-color: #f9fafb;
        font-weight: 600;
        color: #374151;
      }
      .table-actions {
        white-space: nowrap;
      }
      .table-actions .btn,
      .table-actions .btn-link {
        margin-right: 0.3rem;
        padding: 0.3em 0.6em;
        font-size: 0.8em;
      }
      .table-actions .btn-link {
        padding: 0.2em 0.4em;
      }
      .order-details-row td {
        padding: 1rem;
        background-color: #f9fafb;
      }
      .order-details-content {
        padding: 1rem;
        border: 1px dashed #d1d5db;
        border-radius: 6px;
      }
      .order-product-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.3rem 0;
        border-bottom: 1px solid #eee;
      }
      .order-product-item:last-child {
        border-bottom: none;
      }
      .substitution-status-item {
        padding: 0.5rem;
        border: 1px solid #eee;
        border-radius: 4px;
        margin-bottom: 0.5rem;
        background-color: #f9f9f9;
      }

      /* Listas y √Årbol de Categor√≠as */
      .scrollable-list {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #e5e7eb;
        padding: 0.5rem;
        border-radius: 6px;
        background-color: #f9fafb;
      }
      .category-node,
      .store-list-item-id {
        display: block;
        padding: 0.2rem 0.4rem;
        border-radius: 4px;
        cursor: pointer;
      }
      .category-node:hover,
      .store-list-item-id:hover {
        background-color: #e0e7ff;
      }
      ul.category-tree,
      ul.category-tree ul {
        list-style-type: none;
        padding-left: 0;
      }
      ul.category-tree ul {
        padding-left: 1rem;
      }

      /* Paginaci√≥n */
      .pagination-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 1rem;
        font-size: 0.9em;
      }
      .pagination-controls button {
        margin: 0 0.25rem;
      }
      .pagination-controls button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      /* Visor JSON Fijo */
      .json-viewer-container {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        max-height: 300px;
        overflow-y: auto;
        background-color: #f8f9fa;
        border-top: 2px solid #dee2e6;
        z-index: 900;
        display: flex;
        flex-wrap: wrap;
      }
      .json-viewer-section {
        flex: 1;
        min-width: 300px;
        padding: 0.5rem;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        max-height: 290px;
      }
      .json-viewer-section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.3rem;
        flex-shrink: 0;
      }
      .json-viewer-section h4 {
        font-size: 0.9em;
        color: #495057;
        margin-bottom: 0;
      }
      .json-viewer {
        background-color: #1f2937;
        color: #d1d5db;
        padding: 0.8rem;
        border-radius: 6px;
        font-family: "Menlo", "Consolas", "Liberation Mono", monospace;
        font-size: 0.8em;
        white-space: pre;
        overflow: auto;
        flex-grow: 1;
        border: 1px solid #374151;
      }

      /* Mensajes de Alerta */
      .alert {
        padding: 0.8rem 1rem;
        margin-top: 1rem;
        border-radius: 6px;
        font-size: 0.9em;
        border: 1px solid transparent;
      }
      .alert-error {
        background-color: #fee2e2;
        color: #b91c1c;
        border-color: #fca5a5;
      }
      .alert-success {
        background-color: #d1fae5;
        color: #047857;
        border-color: #6ee7b7;
      }
      .alert-info {
        background-color: #dbeafe;
        color: #1d4ed8;
        border-color: #93c5fd;
      }

      /* Toast Notification */
      #toast-notification {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: #333;
        color: white;
        padding: 10px 20px;
        border-radius: 5px;
        z-index: 2000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.5s, visibility 0.5s;
      }
      #toast-notification.show {
        opacity: 1;
        visibility: visible;
      }

      /* Utilidades */
      .text-center {
        text-align: center;
      }
      .w-full {
        width: 100%;
      }
      .opacity-50 {
        opacity: 0.5;
      }
      .cursor-not-allowed {
        cursor: not-allowed;
      }
      .break-all {
        word-break: break-all;
      }
      .space-x-2 > :not([hidden]) ~ :not([hidden]) {
        margin-left: 0.5rem;
      }
      .grid {
        display: grid;
      }
      .grid-cols-2 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      .grid-cols-3 {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
      .md-col-span-2 {
        grid-column: span 2 / span 2;
      }
      .gap-2 {
        gap: 0.5rem;
      }
      .gap-4 {
        gap: 1rem;
      }
      .items-center {
        align-items: center;
      }
      .justify-between {
        justify-content: space-between;
      }
      .justify-end {
        justify-content: flex-end;
      }
      .flex {
        display: flex;
      }
      .mb-1 {
        margin-bottom: 0.25rem;
      }
      .mb-2 {
        margin-bottom: 0.5rem;
      }
      .mb-4 {
        margin-bottom: 1rem;
      }
      .mt-1 {
        margin-top: 0.25rem;
      }
      .mt-2 {
        margin-top: 0.5rem;
      }
      .mt-4 {
        margin-top: 1rem;
      }
      .mt-8 {
        margin-top: 2rem;
      }
      .p-1 {
        padding: 0.25rem;
      }
      .p-2 {
        padding: 0.5rem;
      }
      .text-xs {
        font-size: 0.75rem;
      }
      .text-sm {
        font-size: 0.875rem;
      }
      .text-red-500 {
        color: #ef4444;
      }
      .text-gray-500 {
        color: #6b7280;
      }
      .text-gray-600 {
        color: #4b5563;
      }
      .text-blue-600 {
        color: #2563eb;
      }
      .bg-gray-50 {
        background-color: #f9fafb;
      }
      .bg-gray-100 {
        background-color: #f3f4f6;
      }
      .border-b {
        border-bottom-width: 1px;
      }
      .list-disc {
        list-style-type: disc;
      }
      .list-inside {
        list-style-position: inside;
      }
      .pl-5 {
        padding-left: 1.25rem;
      }

      .variation-block {
        border: 1px solid #e0e0e0;
        padding: 1rem;
        margin-top: 1rem;
        border-radius: 6px;
      }
      .attribute-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
      }
      .attribute-item label {
        margin-bottom: 0;
        min-width: 120px; /* Para alinear los inputs */
      }
      .substitute-product-search-result-item {
        display: flex;
        align-items: center;
        padding: 0.5rem;
        border-bottom: 1px solid #eee;
        cursor: pointer;
      }
      .substitute-product-search-result-item:hover {
        background-color: #f0f2f5;
      }
      .substitute-product-search-result-item img {
        width: 40px;
        height: 40px;
        object-fit: cover;
        margin-right: 0.5rem;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <div id="app" class="container" style="background-color: #ffffff"></div>

    <div id="createProductModal" class="modal-overlay"></div>
    <div id="editProductModal" class="modal-overlay"></div>
    <div id="desassociateModal" class="modal-overlay"></div>
    <div id="deleteCatalogProductModal" class="modal-overlay"></div>
    <div id="associateModal" class="modal-overlay"></div>
    <div id="storesListModal" class="modal-overlay"></div>
    <div id="requestCourierModal" class="modal-overlay"></div>
    <div id="handshakeModal" class="modal-overlay"></div>
    <div id="confirmRemoveProductModal" class="modal-overlay"></div>
    <div id="substituteProductModal" class="modal-overlay"></div>
    <div id="toast-notification"></div>

    <div class="json-viewer-container">
      <div class="json-viewer-section">
        <div class="json-viewer-section-header">
          <h4>√öltima URL y M√©todo API Solicitado:</h4>
          <button class="btn btn-copy" id="copyApiUrlBtn">Copiar</button>
        </div>
        <pre class="json-viewer"><code id="lastApiUrlDisplay">N/A</code></pre>
      </div>
      <div class="json-viewer-section">
        <div class="json-viewer-section-header">
          <h4>√öltima Solicitud API (Cuerpo):</h4>
          <button class="btn btn-copy" id="copyApiRequestBodyBtn">
            Copiar
          </button>
        </div>
        <pre class="json-viewer"><code id="lastRequestBodyJson">N/A</code></pre>
      </div>
      <div class="json-viewer-section">
        <div class="json-viewer-section-header">
          <h4>√öltima Respuesta API:</h4>
          <button class="btn btn-copy" id="copyApiResponseBtn">Copiar</button>
        </div>
        <pre
          class="json-viewer"
        ><code id="lastResponseDataJson">N/A</code></pre>
      </div>
    </div>

    <script type="module">
      // Referencias a elementos del DOM
      const appDiv = document.getElementById("app");
      const createProductModalEl =
        document.getElementById("createProductModal");
      const editProductModalEl = document.getElementById("editProductModal");
      const desassociateModalEl = document.getElementById("desassociateModal");
      const deleteCatalogProductModalEl = document.getElementById(
        "deleteCatalogProductModal"
      );
      const associateModalEl = document.getElementById("associateModal");
      const storesListModalEl = document.getElementById("storesListModal");
      const requestCourierModalEl = document.getElementById(
        "requestCourierModal"
      );
      const handshakeModalEl = document.getElementById("handshakeModal");
      const confirmRemoveProductModalEl = document.getElementById(
        "confirmRemoveProductModal"
      );
      const substituteProductModalEl = document.getElementById(
        "substituteProductModal"
      );
      const toastNotificationEl = document.getElementById("toast-notification");

      // Estado de la aplicaci√≥n
      let selectedCountry = "PER";
      let clientId = "";
      let clientSecret = "";
      let accessToken = "";
      let expiresIn = 0;
      let tokenType = "";
      let tokenExpirationTimestamp = 0;
      let tokenTimeRemaining = "";
      let tokenIntervalId = null;

      let isLoading = false;
      let apiGlobalErrorMessage = "";
      let apiGlobalSuccessMessage = "";
      let apiGlobalInfoMessage = "";

      let lastApiRequestUrlAndMethod = "N/A";
      let lastApiRequestBodyString = "N/A";
      let lastApiResponseDataString = "N/A";

      let categories = [];
      let isLoadingCategories = false;

      let categoryTreeData = null;
      let isLoadingCategoryTree = false;

      let allCatalogProducts = [];
      let productsToDisplay = [];
      let isLoadingProducts = false;
      let currentCatalogPage = 1;
      const catalogItemsPerPage = 10;
      let currentCatalogSearchTerm = "";

      let showCreateProductModal = false;
      let newProduct = {
        sku: "",
        name: "",
        description: "",
        ean: "",
        category_id: "",
        presentation_quantity: 1,
        presentation_unit_type: "Und",
        images: [
          {
            path: "https://placehold.co/600x400/FF0000/FFFFFF.png?text=Producto",
            position: 1,
          },
        ],
        has_variation: false,
        variations: [
          {
            sku: "",
            ean: "",
            name: "",
            images: [
              {
                path: "https://placehold.co/600x400/00FF00/FFFFFF.png?text=Variacion1",
                position: 1,
              },
            ],
            attributes: {},
          },
        ],
        attributes: {},
      };
      let isSubmittingProduct = false;
      let availableAttributes = [];
      let isLoadingAttributes = false;

      let showEditProductModal = false;
      let productToEdit = null;
      let editedProductData = {};
      let isUpdatingCatalogProduct = false;

      let productToDesassociateId = null;
      let storeToDesassociateFromId = null;
      let isDeletingProductFromStore = false;

      let storesList = [];
      let isLoadingStores = false;
      let showAssociateModal = false;
      let productToAssociate = null;
      let isAssociatingProduct = false;

      let showDesassociateModal = false;
      let showDeleteCatalogProductModal = false;
      let productToDeleteFromCatalog = null;
      let isDeletingFromCatalog = false;
      let showStoresListModal = false;

      let orders = [];
      let displayedOrders = [];
      let isLoadingOrders = false;
      let orderActionInProgress = false;
      let currentOrderSearchTerm = "";

      let isPollingActive = false;
      let pollingIntervalId = null;
      let pollingFrequency = 30000;
      let timeToNextPoll = 0;
      let pollingCountdownIntervalId = null;

      let showRequestCourierModal = false;
      let orderToRequestCourier = null;
      let selectedVehicleTypeForCourier = "motorbike";
      let isRequestingCourier = false;

      let showHandshakeModal = false;
      let orderForHandshake = null;
      let handshakeCodes = [];
      let handshakeExpiresAt = null;
      let codeToValidateByRT = "";
      let isRequestingHandshakeCodes = false;
      let isValidatingHandshakeCode = false;
      let handshakeMessage = "";

      let showRemoveProductModal = false;
      let orderProductToRemove = null;
      let isRemovingProductFromOrder = false;

      // Estados para Sustituciones
      let showSubstituteModal = false;
      let orderForSubstitution = null;
      let productToSubstituteDetails = null;
      let substituteProductData = {
        id: "",
        name: "",
        units: 1,
        weight_units: null,
      };
      let isInitiatingSubstitution = false;
      let isLoadingSubstitutionStatuses = false;
      let substituteCatalogSearchTerm = "";
      let substituteCatalogSearchResults = [];

      const countryBaseUrls = {
        ARG: "https://services.rappi.com.ar",
        BRA: "https://services.rappi.com.br",
        CHL: "https://services.rappi.cl",
        COL: "https://services.grability.rappi.com",
        CRI: "https://services.rappi.co.cr",
        ECU: "https://services.rappi.com.ec",
        MEX: "https://services.mxgrability.rappi.com",
        PER: "https://services.rappi.pe",
        URY: "https://services.rappi.com.uy",
      };
      const countryImageBaseUrls = {
        ARG: "https://images.rappi.com.ar/products/",
        BRA: "https://images.rappi.com.br/products/",
        CHL: "https://images.rappi.cl/products/",
        COL: "https://images.rappi.com/products/",
        CRI: "https://images.rappi.com.cr/products/",
        ECU: "https://images.rappi.com.ec/products/",
        MEX: "https://images.rappi.com.mx/products/",
        PER: "https://images.rappi.pe/products/",
        URY: "https://images.rappi.com.uy/products/",
      };

      function getRappiImageUrl(imagePath) {
        if (
          !imagePath ||
          imagePath.startsWith("http") ||
          imagePath.startsWith("data:")
        ) {
          return (
            imagePath ||
            "https://placehold.co/100x100/cccccc/969696.png?text=No+Img"
          );
        }
        const baseUrl =
          countryImageBaseUrls[selectedCountry] || countryImageBaseUrls["COL"];
        return `${baseUrl}${imagePath}`;
      }

      function showToast(message) {
        toastNotificationEl.textContent = message;
        toastNotificationEl.classList.add("show");
        setTimeout(() => {
          toastNotificationEl.classList.remove("show");
        }, 2000);
      }

      function copyToClipboard(text, type) {
        if (
          !text ||
          text === "N/A (GET o sin cuerpo)" ||
          text === "Cargando respuesta..." ||
          text === "N/A"
        ) {
          showToast(`No hay contenido para copiar de ${type}.`);
          return;
        }
        const textArea = document.createElement("textarea");
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        try {
          document.execCommand("copy");
          showToast(`${type} copiado al portapapeles!`);
        } catch (err) {
          console.error(`Error al copiar ${type} con execCommand: `, err);
          navigator.clipboard
            .writeText(text)
            .then(() => {
              showToast(`${type} copiado al portapapeles! (navigator)`);
            })
            .catch((navErr) => {
              console.error(
                `Error al copiar ${type} con navigator.clipboard: `,
                navErr
              );
              showToast(`Error al copiar ${type}. Revisa la consola.`);
            });
        }
        document.body.removeChild(textArea);
      }

      function clearGlobalMessages() {
        apiGlobalErrorMessage = "";
        apiGlobalSuccessMessage = "";
        apiGlobalInfoMessage = "";
      }

      function setGlobalApiMessage(type, message) {
        clearGlobalMessages();
        if (type === "success") apiGlobalSuccessMessage = message;
        else if (type === "error") apiGlobalErrorMessage = message;
        else if (type === "info") apiGlobalInfoMessage = message;
        renderAppOnly();
      }

      async function makeApiCall(
        url,
        method = "GET",
        body = null,
        requiresAuth = true,
        customHeaders = {}
      ) {
        lastApiRequestUrlAndMethod = `${method} ${url}`;
        lastApiRequestBodyString = body
          ? JSON.stringify(body, null, 2)
          : "N/A (GET o sin cuerpo)";
        lastApiResponseDataString = "Cargando respuesta...";
        renderJsonViewers();

        const headers = {
          "Content-Type": "application/json",
          ...customHeaders,
        };
        if (requiresAuth && accessToken) {
          headers["Authorization"] = `${tokenType} ${accessToken}`;
        }

        const config = { method, headers };
        if (
          body &&
          (method === "POST" || method === "PUT" || method === "PATCH")
        ) {
          config.body = JSON.stringify(body);
        }

        let responseDataText = "";

        try {
          const response = await fetch(url, config);
          responseDataText = await response.text();

          if (
            response.status === 204 &&
            (method === "DELETE" || method === "PATCH" || method === "POST")
          ) {
            lastApiResponseDataString = `√âxito: ${response.status} No Content`;
            renderJsonViewers();
            return { success: true, status: 204 };
          }

          if (
            response.ok &&
            response.headers.get("content-length") === "0" &&
            !responseDataText
          ) {
            lastApiResponseDataString = `√âxito: ${response.status} OK (Respuesta vac√≠a)`;
            renderJsonViewers();
            return { success: true, status: response.status, data: {} };
          }

          let data = null;
          if (responseDataText) {
            try {
              data = JSON.parse(responseDataText);
            } catch (parseError) {
              if (response.ok) {
                lastApiResponseDataString = `Respuesta OK pero no es JSON v√°lido:\n${responseDataText}`;
                renderJsonViewers();
                return {
                  success: true,
                  status: response.status,
                  rawData: responseDataText,
                };
              }
              throw new Error(
                `Error ${response.status}: Respuesta no es JSON v√°lido. Cuerpo: ${responseDataText}`
              );
            }
          } else if (response.ok) {
            data = {
              success: true,
              message: "Operaci√≥n exitosa, respuesta vac√≠a.",
            };
          }

          lastApiResponseDataString = JSON.stringify(data, null, 2);
          renderJsonViewers();

          if (response.ok) {
            return data;
          } else {
            let rappiErrorMsg = `Error ${response.status}`;
            if (data) {
              if (data.message && typeof data.message === "string")
                rappiErrorMsg += `: ${data.message}`;
              else if (
                data.message &&
                data.message.message &&
                typeof data.message.message === "string"
              )
                rappiErrorMsg += `: ${data.message.message}`;
              else if (
                data.error &&
                data.error.message &&
                typeof data.error.message === "string"
              )
                rappiErrorMsg += `: ${data.error.message}`;
              else if (data.error_description)
                rappiErrorMsg += `: ${data.error_description}`;
              else if (
                data.product &&
                data.product.unsuccessful &&
                data.product.unsuccessful.length > 0
              ) {
                const firstError = data.product.unsuccessful[0];
                rappiErrorMsg += `: Producto SKU ${firstError.sku} - ${
                  firstError.error?.message?.message ||
                  JSON.stringify(firstError.error?.message || firstError.error)
                }`;
              } else {
                rappiErrorMsg += `: ${JSON.stringify(data)}`;
              }
            } else {
              rappiErrorMsg += `: ${
                responseDataText || "(Sin cuerpo en la respuesta de error)"
              }`;
            }
            throw new Error(rappiErrorMsg);
          }
        } catch (error) {
          if (
            error instanceof SyntaxError &&
            !lastApiResponseDataString.startsWith("Error al parsear")
          ) {
            lastApiResponseDataString = `Error al parsear JSON de respuesta:\n${responseDataText}`;
          } else if (
            !lastApiResponseDataString.startsWith("Error al parsear")
          ) {
            lastApiResponseDataString = error.message;
          }
          renderJsonViewers();
          console.error(
            `Error en API ${method} ${url}:`,
            error,
            "Respuesta cruda:",
            responseDataText
          );
          throw error;
        }
      }

      function updateTokenTimer() {
        if (tokenIntervalId) clearInterval(tokenIntervalId);
        tokenTimeRemaining =
          "El token usualmente expira a medianoche (hora Colombia).";
        const timerEl = document.getElementById("tokenTimerDisplay");
        if (timerEl) timerEl.textContent = tokenTimeRemaining;
      }

      async function handleLogin() {
        if (!clientId || !clientSecret) {
          setGlobalApiMessage(
            "error",
            "Por favor, ingresa Client ID y Client Secret."
          );
          return;
        }
        isLoading = true;
        clearGlobalMessages();
        accessToken = "";
        tokenExpirationTimestamp = 0;
        updateTokenTimer();
        renderAppOnly();
        const loginUrl = `${countryBaseUrls[selectedCountry]}/api/open-api/login`;
        try {
          const data = await makeApiCall(
            loginUrl,
            "POST",
            { client_id: clientId, client_secret: clientSecret },
            false
          );
          if (data && data.access_token) {
            accessToken = data.access_token;
            expiresIn = data.expires_in || 86400;
            tokenType = data.token_type;
            tokenExpirationTimestamp =
              Math.floor(Date.now() / 1000) + expiresIn;
            updateTokenTimer();
            setGlobalApiMessage(
              "success",
              `¬°Autenticaci√≥n exitosa! El token usualmente expira a medianoche (hora Colombia).`
            );
          } else {
            setGlobalApiMessage(
              "error",
              "Respuesta de autenticaci√≥n inesperada. Revisa el visor JSON."
            );
          }
        } catch (error) {
          let detailedErrorMessage = `Error de autenticaci√≥n: ${error.message}.`;
          if (error.message.includes("401")) {
            detailedErrorMessage +=
              " Por favor, verifica que tu Client ID y Client Secret sean correctos.";
          }
          setGlobalApiMessage("error", detailedErrorMessage);
        } finally {
          isLoading = false;
          renderAppOnly();
        }
      }

      async function handleViewCategories() {
        if (!accessToken) {
          setGlobalApiMessage("error", "Debes autenticarte primero.");
          return;
        }
        isLoadingCategories = true;
        clearGlobalMessages();
        categories = [];
        renderAppOnly();
        const url = `${countryBaseUrls[selectedCountry]}/api/open-api/v1/catalog/categories`;
        try {
          const data = await makeApiCall(url);
          if (data && data.data) {
            categories = data.data;
            setGlobalApiMessage(
              "success",
              "Lista de categor√≠as principales cargada."
            );
          } else {
            setGlobalApiMessage(
              "error",
              "No se pudieron cargar las categor√≠as o la respuesta no tiene el formato esperado."
            );
          }
        } catch (error) {
          setGlobalApiMessage(
            "error",
            `Error al cargar categor√≠as: ${error.message}`
          );
        } finally {
          isLoadingCategories = false;
          renderAppOnly();
        }
      }

      async function fetchCategoryTree(
        targetInputId = "newProdCatId",
        targetObject = newProduct,
        modalType = "create"
      ) {
        if (!accessToken) {
          showToast("Error: Debes autenticarte primero.");
          return;
        }
        isLoadingCategoryTree = true;
        categoryTreeData = null;

        const url = `${countryBaseUrls[selectedCountry]}/api/open-api/v1/catalog/category-tree`;
        let containerId =
          modalType === "create"
            ? "categoryTreeContainer"
            : "editCategoryTreeContainer";

        const container = document.getElementById(containerId);

        if (container)
          container.innerHTML = '<p class="text-xs">Cargando √°rbol...</p>';
        renderSpecificModal(modalType);

        try {
          const data = await makeApiCall(url);
          if (data && data.id && data.name) {
            categoryTreeData = data;
            if (container) {
              container.style.display = "block";
              container.innerHTML = renderCategoryTreeNode(categoryTreeData);
              container.querySelectorAll(".category-node").forEach((nodeEl) => {
                nodeEl.addEventListener("click", (ev) => {
                  const catId = ev.currentTarget.dataset.id;
                  const catName = ev.currentTarget.dataset.name;
                  if (catId && catId !== "null") {
                    const inputEl = document.getElementById(targetInputId);
                    if (inputEl) inputEl.value = catId;

                    targetObject.category_id = catId;

                    showToast(`Categor√≠a copiada: ${catName} (ID: ${catId})`);
                    fetchCategoryAttributes(catId, modalType);
                  }
                });
              });
            }
          } else {
            if (container)
              container.innerHTML =
                '<p class="text-xs">Error al cargar √°rbol o formato inesperado.</p>';
          }
        } catch (error) {
          if (container)
            container.innerHTML = `<p class="text-xs">Error al cargar √°rbol: ${error.message}</p>`;
        } finally {
          isLoadingCategoryTree = false;
          renderSpecificModal(modalType);
        }
      }

      async function fetchCategoryAttributes(
        categoryId,
        modalTypeToRender = "create"
      ) {
        if (!categoryId) {
          availableAttributes = [];
          renderSpecificModal(modalTypeToRender);
          return;
        }
        isLoadingAttributes = true;
        availableAttributes = [];

        let attributesContainerId =
          modalTypeToRender === "create"
            ? "newProdAttributesContainer"
            : "editProdAttributesContainer";

        const attributesContainer = document.getElementById(
          attributesContainerId
        );
        if (attributesContainer)
          attributesContainer.innerHTML =
            '<p class="text-xs">Cargando atributos...</p>';

        renderSpecificModal(modalTypeToRender);

        const url = `${countryBaseUrls[selectedCountry]}/api/open-api/v1/catalog/categories/${categoryId}`;
        try {
          const data = await makeApiCall(url);
          if (data && data.attributes && Array.isArray(data.attributes)) {
            availableAttributes = data.attributes;
            if (availableAttributes.length === 0) {
              if (attributesContainer)
                attributesContainer.innerHTML =
                  '<p class="text-xs">No hay atributos espec√≠ficos para esta categor√≠a.</p>';
            }
          } else if (data && data.type === "internal server error") {
            if (attributesContainer)
              attributesContainer.innerHTML =
                '<p class="text-xs text-orange-500">No hay atributos disponibles para esta categor√≠a (respuesta de API: error interno). Puede continuar sin ellos.</p>';
            availableAttributes = [];
          } else {
            if (attributesContainer)
              attributesContainer.innerHTML =
                '<p class="text-xs">No se encontraron atributos o la respuesta fue inesperada.</p>';
            availableAttributes = [];
          }
        } catch (error) {
          console.error(
            `Error al cargar atributos para categor√≠a ${categoryId}:`,
            error
          );
          if (attributesContainer)
            attributesContainer.innerHTML = `<p class="text-xs text-red-500">Error al cargar atributos. Puede continuar sin ellos.</p>`;
          availableAttributes = [];
        } finally {
          isLoadingAttributes = false;
          renderSpecificModal(modalTypeToRender);
        }
      }

      function renderCategoryTreeNode(node, level = 0) {
        if (!node || !node.name) return "";
        let html = `<li style="padding-left: ${
          level * 15
        }px; list-style-type: none;">
                <span class="category-node" data-id="${node.id}" data-name="${
          node.name
        }">
                    ${
                      level > 0
                        ? node.children && node.children.length > 0
                          ? "üìÅ"
                          : "ÔøΩ"
                        : "üå≥"
                    } ${
          node.name
        } (ID: <span class="category-id-copy" title="Copiar ID">${
          node.id
        }</span>)
                </span>
            </li>`;
        if (node.children && node.children.length > 0) {
          html += `<ul class="category-tree">`;
          node.children.forEach((child) => {
            html += renderCategoryTreeNode(child, level + 1);
          });
          html += `</ul>`;
        }
        return html;
      }

      function applyCatalogSearchAndPaginate() {
        let productsToFilter = allCatalogProducts;
        if (currentCatalogSearchTerm) {
          const searchTerm = currentCatalogSearchTerm.toLowerCase();
          productsToFilter = allCatalogProducts.filter(
            (p) =>
              (p.sku && p.sku.toLowerCase().includes(searchTerm)) ||
              (p.name && p.name.toLowerCase().includes(searchTerm))
          );
        }
        const startIndex = (currentCatalogPage - 1) * catalogItemsPerPage;
        const endIndex = startIndex + catalogItemsPerPage;
        productsToDisplay = productsToFilter.slice(startIndex, endIndex);
      }

      function handlePreviousCatalogPage() {
        if (currentCatalogPage > 1) {
          currentCatalogPage--;
          applyCatalogSearchAndPaginate();
          renderAppOnly();
        }
      }

      function handleNextCatalogPage() {
        const sourceList = currentCatalogSearchTerm
          ? allCatalogProducts.filter(
              (p) =>
                (p.sku &&
                  p.sku
                    .toLowerCase()
                    .includes(currentCatalogSearchTerm.toLowerCase())) ||
                (p.name &&
                  p.name
                    .toLowerCase()
                    .includes(currentCatalogSearchTerm.toLowerCase()))
            )
          : allCatalogProducts;
        const totalPages = Math.ceil(sourceList.length / catalogItemsPerPage);
        if (currentCatalogPage < totalPages) {
          currentCatalogPage++;
          applyCatalogSearchAndPaginate();
          renderAppOnly();
        }
      }

      async function fetchCatalogProducts() {
        if (!accessToken) {
          setGlobalApiMessage("error", "Debes autenticarte primero.");
          return;
        }
        isLoadingProducts = true;
        clearGlobalMessages();
        allCatalogProducts = [];
        productsToDisplay = [];
        currentCatalogPage = 1;
        const searchInput = document.getElementById("catalogSearchInput");
        if (searchInput) currentCatalogSearchTerm = searchInput.value;
        renderAppOnly();
        const url = `${countryBaseUrls[selectedCountry]}/api/open-api/v1/catalog/products?limit=100`;
        try {
          const data = await makeApiCall(url);
          if (data && data.data) {
            allCatalogProducts = data.data.map((p) => ({ ...p }));
            setGlobalApiMessage(
              "success",
              `Se cargaron ${allCatalogProducts.length} productos del cat√°logo.`
            );
            applyCatalogSearchAndPaginate();
          } else {
            setGlobalApiMessage(
              "error",
              "No se pudieron cargar los productos del cat√°logo o la respuesta no tiene el formato esperado."
            );
          }
        } catch (error) {
          setGlobalApiMessage(
            "error",
            `Error al cargar productos del cat√°logo: ${error.message}`
          );
        } finally {
          isLoadingProducts = false;
          renderAppOnly();
        }
      }

      function handleCatalogSearch() {
        currentCatalogSearchTerm =
          document.getElementById("catalogSearchInput")?.value || "";
        currentCatalogPage = 1;
        applyCatalogSearchAndPaginate();
        renderAppOnly();
      }

      function clearCatalogSearch() {
        currentCatalogSearchTerm = "";
        const searchInput = document.getElementById("catalogSearchInput");
        if (searchInput) searchInput.value = "";
        currentCatalogPage = 1;
        applyCatalogSearchAndPaginate();
        renderAppOnly();
      }

      function openCreateProductModal() {
        showCreateProductModal = true;
        newProduct = {
          sku: "",
          name: "",
          description: "",
          ean: "",
          category_id: "",
          presentation_quantity: 1,
          presentation_unit_type: "Und",
          images: [
            {
              path: "https://placehold.co/600x400/FF0000/FFFFFF.png?text=Producto",
              position: 1,
            },
          ],
          has_variation: false,
          variations: [
            {
              sku: "",
              ean: "",
              name: "",
              images: [
                {
                  path: "https://placehold.co/600x400/00FF00/FFFFFF.png?text=Variacion1",
                  position: 1,
                },
              ],
              attributes: {},
            },
          ],
          attributes: {},
        };
        availableAttributes = [];
        categoryTreeData = null;
        clearGlobalMessages();
        renderCreateProductModal();
        createProductModalEl.classList.add("active");
      }

      function closeCreateProductModal() {
        showCreateProductModal = false;
        createProductModalEl.classList.remove("active");
        renderAppOnly();
      }

      async function handleCreateProduct(event, productDataToCreate) {
        if (event) event.preventDefault();
        const productDetails = productDataToCreate || newProduct;

        if (!accessToken) {
          setGlobalApiMessage("error", "Debes autenticarte primero.");
          return null;
        }
        if (!productDetails.name || !productDetails.category_id) {
          setGlobalApiMessage(
            "error",
            "Nombre del producto y ID de Categor√≠a son obligatorios."
          );
          return null;
        }
        if (isNaN(parseInt(productDetails.category_id))) {
          setGlobalApiMessage(
            "error",
            "ID de Categor√≠a debe ser un n√∫mero v√°lido."
          );
          return null;
        }

        if (!productDetails.has_variation) {
          if (!productDetails.sku || !productDetails.ean) {
            setGlobalApiMessage(
              "error",
              "SKU y EAN son obligatorios para productos sin variaciones."
            );
            return null;
          }
          if (
            isNaN(parseFloat(productDetails.presentation_quantity)) ||
            parseFloat(productDetails.presentation_quantity) <= 0
          ) {
            setGlobalApiMessage(
              "error",
              "Cantidad de Presentaci√≥n debe ser un n√∫mero mayor a 0."
            );
            return null;
          }
        } else {
          if (
            !productDetails.variations ||
            productDetails.variations.length === 0
          ) {
            setGlobalApiMessage("error", "Debe a√±adir al menos una variaci√≥n.");
            return null;
          }
          for (const variation of productDetails.variations) {
            if (!variation.sku || !variation.ean || !variation.name) {
              setGlobalApiMessage(
                "error",
                `Cada variaci√≥n debe tener SKU, EAN y Nombre. Revise la variaci√≥n con SKU: ${
                  variation.sku || "(vac√≠o)"
                }.`
              );
              return null;
            }
          }
        }

        isSubmittingProduct = true;
        clearGlobalMessages();
        if (!productDataToCreate) renderCreateProductModal();
        else renderEditProductModal();

        const url = `${countryBaseUrls[selectedCountry]}/api/open-api/v1/catalog/products`;

        const basePayload = {
          category_id: parseInt(productDetails.category_id),
          name: productDetails.name,
          description: productDetails.description,
          has_variation: productDetails.has_variation,
          presentation: {
            quantity: parseFloat(productDetails.presentation_quantity),
            unitType: productDetails.presentation_unit_type,
          },
          sellType: {
            type: "U",
            minQuantity: 1,
            maxQuantity: 100,
            stepQuantity: 1,
          },
        };

        if (productDetails.has_variation) {
          basePayload.product = productDetails.variations.map((v) => ({
            sku: v.sku,
            ean: v.ean && v.ean.toUpperCase() === "NULL" ? null : v.ean,
            name: v.name,
            images: v.images.filter(
              (img) =>
                img.path &&
                img.path.trim() !== "" &&
                (img.path.startsWith("http") || img.path.startsWith("data:"))
            ),
            attributes: v.attributes || {},
          }));
        } else {
          basePayload.product = [
            {
              sku: productDetails.sku,
              ean:
                productDetails.ean &&
                productDetails.ean.toUpperCase() === "NULL"
                  ? null
                  : productDetails.ean,
              name: productDetails.name,
              images: productDetails.images.filter(
                (img) =>
                  img.path &&
                  img.path.trim() !== "" &&
                  (img.path.startsWith("http") || img.path.startsWith("data:"))
              ),
              attributes: productDetails.attributes || {},
            },
          ];
        }

        try {
          const data = await makeApiCall(url, "POST", basePayload);
          if (
            data &&
            data.product &&
            data.product.successful &&
            data.product.successful.length > 0
          ) {
            const createdRappiProducts = data.product.successful;
            if (!productDataToCreate) {
              createdRappiProducts.forEach((createdProd) => {
                allCatalogProducts.unshift({
                  id: createdProd.id,
                  sku: createdProd.sku,
                  name: productDetails.has_variation
                    ? `${productDetails.name} - ${createdProd.sku}`
                    : productDetails.name,
                  ean: createdProd.ean,
                  description: productDetails.description,
                  category_id: productDetails.category_id,
                  presentation: basePayload.presentation,
                  images: productDetails.has_variation
                    ? productDetails.variations.find(
                        (v) => v.sku === createdProd.sku
                      )?.images || []
                    : productDetails.images,
                  parent_id: createdProd.parent_id,
                });
              });

              applyCatalogSearchAndPaginate();
              setGlobalApiMessage(
                "success",
                `Producto(s) "${
                  productDetails.name
                }" creado(s) con ID(s) Rappi: ${createdRappiProducts
                  .map((p) => p.id)
                  .join(", ")}.`
              );
              closeCreateProductModal();
            }
            return createdRappiProducts;
          } else if (
            data &&
            data.product &&
            data.product.unsuccessful &&
            data.product.unsuccessful.length > 0
          ) {
            const errorDetail = data.product.unsuccessful[0].error.message;
            setGlobalApiMessage(
              "error",
              `Error al crear producto: ${
                errorDetail.message || JSON.stringify(errorDetail)
              }`
            );
          } else {
            setGlobalApiMessage(
              "error",
              "Error al crear el producto. Respuesta no esperada."
            );
          }
        } catch (error) {
          setGlobalApiMessage(
            "error",
            `Error al crear producto: ${error.message}`
          );
        } finally {
          isSubmittingProduct = false;
          if (!productDataToCreate) renderCreateProductModal();
          else renderEditProductModal();
        }
        return null;
      }

      function openEditProductModal(productId) {
        const product = allCatalogProducts.find(
          (p) => p.id.toString() === productId.toString()
        );
        if (product) {
          productToEdit = { ...product };
          editedProductData = {
            sku: product.sku || "",
            name: product.name || "",
            description: product.description || "",
            ean: product.ean || "",
            category_id: product.category_id || product.categoryId || "",
            presentation_quantity:
              product.presentation?.quantity !== undefined
                ? product.presentation.quantity
                : 1,
            presentation_unit_type: product.presentation?.unitType || "Und",
            images:
              product.images && product.images.length > 0
                ? product.images.map((img) => ({
                    path: getRappiImageUrl(img.path),
                    position: img.position,
                  }))
                : [{ path: "", position: 1 }],
            has_variation: product.parent_id ? true : false,
            attributes: product.attributes || {},
          };
          availableAttributes = [];
          categoryTreeData = null;
          showEditProductModal = true;
          clearGlobalMessages();
          renderEditProductModal();
          editProductModalEl.classList.add("active");
          if (editedProductData.category_id) {
            fetchCategoryAttributes(editedProductData.category_id, "edit");
          }
        } else {
          setGlobalApiMessage(
            "error",
            `No se encontr√≥ el producto con ID ${productId} para editar.`
          );
        }
      }

      function closeEditProductModal() {
        showEditProductModal = false;
        productToEdit = null;
        editedProductData = {};
        editProductModalEl.classList.remove("active");
        renderAppOnly();
      }

      async function handleEditCatalogProductWorkflow(event) {
        event.preventDefault();
        if (!productToEdit || !editedProductData) {
          setGlobalApiMessage("error", "No hay datos de producto para editar.");
          return;
        }
        isUpdatingCatalogProduct = true;
        clearGlobalMessages();
        renderEditProductModal();
        setGlobalApiMessage(
          "info",
          `Iniciando flujo de edici√≥n para "${productToEdit.name}" (ID Rappi original: ${productToEdit.id})...`
        );

        let oldProductSuccessfullyDeletedFromRappi = false;
        try {
          setGlobalApiMessage(
            "info",
            `Paso 1: Intentando eliminar producto original ID ${productToEdit.id} del cat√°logo de Rappi...`
          );
          const deleteUrl = `${countryBaseUrls[selectedCountry]}/api/open-api/v1/catalog/products/${productToEdit.id}`;
          await makeApiCall(deleteUrl, "DELETE");
          oldProductSuccessfullyDeletedFromRappi = true;
          setGlobalApiMessage(
            "info",
            `Producto original (ID: ${productToEdit.id}) eliminado de Rappi (o ya no exist√≠a).`
          );
        } catch (deleteError) {
          console.warn(
            `Advertencia al intentar eliminar producto original ${productToEdit.id} de Rappi: ${deleteError.message}`
          );
          setGlobalApiMessage(
            "info",
            `Advertencia: No se pudo eliminar el producto original de Rappi (ID: ${productToEdit.id}) o ya no exist√≠a. Procediendo a crear el nuevo...`
          );
        }

        allCatalogProducts = allCatalogProducts.filter(
          (p) => p.id.toString() !== productToEdit.id.toString()
        );
        applyCatalogSearchAndPaginate();

        setGlobalApiMessage(
          "info",
          `Paso 2: Creando nuevo producto con los datos editados...`
        );
        const productPayloadForCreation = {
          sku: editedProductData.sku,
          name: editedProductData.name,
          description: editedProductData.description,
          ean: editedProductData.ean,
          category_id: editedProductData.category_id,
          presentation_quantity: editedProductData.presentation_quantity,
          presentation_unit_type: editedProductData.presentation_unit_type,
          images: editedProductData.images.map((img) => ({
            path: img.path,
            position: img.position,
          })),
          has_variation: false,
          attributes: editedProductData.attributes,
        };

        const createdProductArray = await handleCreateProduct(
          null,
          productPayloadForCreation
        );

        if (
          createdProductArray &&
          createdProductArray.length > 0 &&
          createdProductArray[0].id
        ) {
          const createdProduct = createdProductArray[0];
          setGlobalApiMessage(
            "success",
            `Producto editado exitosamente. Nuevo ID Rappi: ${createdProduct.id}. Recuerda asociar el nuevo producto a las tiendas si es necesario.`
          );
          allCatalogProducts.unshift({
            id: createdProduct.id,
            sku: editedProductData.sku,
            name: editedProductData.name,
            ean: editedProductData.ean,
            description: editedProductData.description,
            category_id: editedProductData.category_id,
            presentation: {
              quantity: editedProductData.presentation_quantity,
              unitType: editedProductData.presentation_unit_type,
            },
            images: editedProductData.images,
            attributes: editedProductData.attributes,
          });
          applyCatalogSearchAndPaginate();
        } else {
          setGlobalApiMessage(
            "error",
            `Fall√≥ la creaci√≥n del nuevo producto durante la edici√≥n. El producto original (ID: ${productToEdit.id}) fue eliminado de la lista local. Revisa los errores e int√©ntalo de nuevo.`
          );
        }
        isUpdatingCatalogProduct = false;
        closeEditProductModal();
      }

      function openDesassociateModal(productId) {
        const product = allCatalogProducts.find(
          (p) => p.id.toString() === productId.toString()
        );
        if (product) {
          productToDesassociateId = product.id;
          showDesassociateModal = true;
          fetchStores("desassociate");
          clearGlobalMessages();
          renderDesassociateModal();
          desassociateModalEl.classList.add("active");
        } else {
          setGlobalApiMessage(
            "error",
            `Producto con ID ${productId} no encontrado.`
          );
        }
      }

      function closeDesassociateModal() {
        showDesassociateModal = false;
        productToDesassociateId = null;
        storeToDesassociateFromId = null;
        storesList = [];
        desassociateModalEl.classList.remove("active");
        renderAppOnly();
      }

      async function confirmDesassociateProductFromStore() {
        if (
          !productToDesassociateId ||
          !storeToDesassociateFromId ||
          !accessToken
        ) {
          setGlobalApiMessage(
            "error",
            "Falta ID de producto, ID de tienda o no est√°s autenticado."
          );
          if (!showDesassociateModal) renderAppOnly();
          else closeDesassociateModal();
          return;
        }
        isDeletingProductFromStore = true;
        clearGlobalMessages();
        renderDesassociateModal();
        const url = `${countryBaseUrls[selectedCountry]}/api/open-api/v1/catalog/stores/${storeToDesassociateFromId}/inventory/${productToDesassociateId}`;
        try {
          await makeApiCall(url, "DELETE");
          setGlobalApiMessage(
            "success",
            `Producto ID ${productToDesassociateId} desasociado exitosamente de la tienda ID ${storeToDesassociateFromId}.`
          );
        } catch (error) {
          setGlobalApiMessage(
            "error",
            `Error al desasociar producto: ${error.message}`
          );
        } finally {
          isDeletingProductFromStore = false;
          closeDesassociateModal();
        }
      }

      function openDeleteCatalogProductModal(productId) {
        const product = allCatalogProducts.find(
          (p) => p.id.toString() === productId.toString()
        );
        if (product) {
          productToDeleteFromCatalog = product;
          showDeleteCatalogProductModal = true;
          clearGlobalMessages();
          renderDeleteCatalogProductModal();
          deleteCatalogProductModalEl.classList.add("active");
        } else {
          setGlobalApiMessage(
            "error",
            `Producto con ID ${productId} no encontrado.`
          );
        }
      }

      function closeDeleteCatalogProductModal() {
        showDeleteCatalogProductModal = false;
        productToDeleteFromCatalog = null;
        deleteCatalogProductModalEl.classList.remove("active");
        renderAppOnly();
      }

      async function confirmDeleteProductFromCatalog() {
        if (!productToDeleteFromCatalog || !accessToken) {
          setGlobalApiMessage(
            "error",
            "No hay producto seleccionado para eliminar o no est√°s autenticado."
          );
          closeDeleteCatalogProductModal();
          return;
        }
        isDeletingFromCatalog = true;
        renderDeleteCatalogProductModal();

        const deleteUrl = `${countryBaseUrls[selectedCountry]}/api/open-api/v1/catalog/products/${productToDeleteFromCatalog.id}`;
        try {
          setGlobalApiMessage(
            "info",
            `Intentando eliminar "${productToDeleteFromCatalog.name}" (ID: ${productToDeleteFromCatalog.id}) del cat√°logo de Rappi...`
          );
          await makeApiCall(deleteUrl, "DELETE");
          allCatalogProducts = allCatalogProducts.filter(
            (p) => p.id.toString() !== productToDeleteFromCatalog.id.toString()
          );
          applyCatalogSearchAndPaginate();
          setGlobalApiMessage(
            "success",
            `Producto "${productToDeleteFromCatalog.name}" eliminado exitosamente de Rappi y de la lista local.`
          );
        } catch (error) {
          setGlobalApiMessage(
            "error",
            `Error al eliminar producto del cat√°logo de Rappi: ${error.message}. El producto se eliminar√° de la lista local de todas formas.`
          );
          allCatalogProducts = allCatalogProducts.filter(
            (p) => p.id.toString() !== productToDeleteFromCatalog.id.toString()
          );
          applyCatalogSearchAndPaginate();
        } finally {
          isDeletingFromCatalog = false;
          closeDeleteCatalogProductModal();
        }
      }

      async function fetchStores(forModal = null) {
        if (!accessToken) {
          setGlobalApiMessage(
            "error",
            "Debes autenticarte para ver las tiendas."
          );
          return;
        }
        isLoadingStores = true;
        clearGlobalMessages();
        storesList = [];
        if (forModal) renderSpecificModal(forModal);
        else renderAppOnly();

        const url = `${countryBaseUrls[selectedCountry]}/api/open-api/v1/catalog/stores`;
        try {
          const data = await makeApiCall(url);
          if (data && data.data) {
            storesList = data.data;
          } else {
            setGlobalApiMessage(
              "error",
              "No se pudieron cargar las tiendas o la respuesta no tiene el formato esperado."
            );
          }
        } catch (error) {
          setGlobalApiMessage(
            "error",
            `Error al cargar tiendas: ${error.message}`
          );
        } finally {
          isLoadingStores = false;
          if (forModal) renderSpecificModal(forModal);
          else renderAppOnly();
        }
      }

      function openStoresListModal() {
        showStoresListModal = true;
        fetchStores("storesList");
        clearGlobalMessages();
        renderStoresListModal();
        storesListModalEl.classList.add("active");
      }
      function closeStoresListModal() {
        showStoresListModal = false;
        storesListModalEl.classList.remove("active");
        renderAppOnly();
      }

      function openAssociateModal(productId) {
        const product = allCatalogProducts.find(
          (p) => p.id.toString() === productId.toString()
        );
        if (product && product.id) {
          productToAssociate = product;
          showAssociateModal = true;
          fetchStores("associate");
          clearGlobalMessages();
          renderAssociateModal();
          associateModalEl.classList.add("active");
        } else {
          setGlobalApiMessage(
            "error",
            `Producto con ID ${productId} no encontrado o sin ID de Rappi.`
          );
        }
      }

      function closeAssociateModal() {
        showAssociateModal = false;
        productToAssociate = null;
        storesList = [];
        associateModalEl.classList.remove("active");
        renderAppOnly();
      }

      async function handleAssociateProductToStores(event) {
        event.preventDefault();
        if (!productToAssociate || !productToAssociate.id || !accessToken) {
          setGlobalApiMessage(
            "error",
            "Falta producto, ID de producto Rappi o autenticaci√≥n."
          );
          return;
        }
        const form = event.target;
        const selectedStoresData = [];
        storesList.forEach((store) => {
          const checkbox = form.querySelector(
            `.store-checkbox[data-store-id="${store.id}"]`
          );
          if (checkbox && checkbox.checked) {
            const priceInput = form.querySelector(
              `.store-price[data-store-id="${store.id}"]`
            );
            const stockInput = form.querySelector(
              `.store-stock[data-store-id="${store.id}"]`
            );
            const salePriceInput = form.querySelector(
              `.store-sale-price[data-store-id="${store.id}"]`
            );

            const regularPrice = parseFloat(priceInput.value);
            const stock = parseInt(stockInput.value);
            let discountPrice = parseFloat(salePriceInput.value);

            if (
              isNaN(regularPrice) ||
              regularPrice < 0 ||
              isNaN(stock) ||
              stock < 0
            ) {
              setGlobalApiMessage(
                "error",
                `Precio Regular y Stock para ${store.name} deben ser n√∫meros v√°lidos y no negativos.`
              );
              selectedStoresData.length = 0;
              return;
            }
            if (isNaN(discountPrice) || discountPrice <= 0) {
              discountPrice = regularPrice;
            } else if (discountPrice > regularPrice) {
              setGlobalApiMessage(
                "error",
                `Precio con descuento para ${store.name} no puede ser mayor al precio regular.`
              );
              selectedStoresData.length = 0;
              return;
            }

            selectedStoresData.push({
              storeId: store.id,
              price: regularPrice,
              stock: stock,
              sale_price: discountPrice,
            });
          }
        });

        if (selectedStoresData.length === 0) {
          if (!apiGlobalErrorMessage)
            setGlobalApiMessage(
              "info",
              "No se seleccionaron tiendas o faltan datos v√°lidos."
            );
          return;
        }

        isAssociatingProduct = true;
        clearGlobalMessages();
        renderAssociateModal();

        let successCount = 0;
        let errorCount = 0;
        const associationResults = [];
        let allSuccessful = true;

        for (const storeData of selectedStoresData) {
          const productIdRappi = productToAssociate.id.toString();
          const associateUrl = `${countryBaseUrls[selectedCountry]}/api/open-api/v1/catalog/stores/${storeData.storeId}/inventory`;
          const associatePayload = {
            id: productIdRappi,
            price: storeData.price,
            stock: storeData.stock,
            sale_price: storeData.sale_price,
          };

          try {
            console.log(
              `Intentando POST para asociar producto ${productIdRappi} en tienda ${storeData.storeId}`
            );
            await makeApiCall(associateUrl, "POST", associatePayload);
            associationResults.push(
              `√âxito (Nueva Asociaci√≥n): ${productToAssociate.name} en tienda ID ${storeData.storeId}.`
            );
            successCount++;
          } catch (postError) {
            // Si el POST falla (ej. 400 por producto ya existente), intentar PUT
            if (
              postError.message &&
              (postError.message.includes("400") ||
                postError.message.includes("already exists") ||
                postError.message.includes("409"))
            ) {
              console.log(
                `POST fall√≥ (posiblemente ya existe o conflicto) para producto ${productIdRappi} en tienda ${storeData.storeId}: ${postError.message}. Intentando PUT para actualizar.`
              );
              const updateUrl = `${countryBaseUrls[selectedCountry]}/api/open-api/v1/catalog/stores/${storeData.storeId}/inventory/${productIdRappi}`;
              const updatePayload = {
                price: storeData.price,
                stock: storeData.stock,
                sale_price: storeData.sale_price,
              };
              try {
                await makeApiCall(updateUrl, "PUT", updatePayload);
                associationResults.push(
                  `√âxito (Actualizaci√≥n): ${productToAssociate.name} actualizado en tienda ID ${storeData.storeId}.`
                );
                successCount++;
              } catch (putError) {
                associationResults.push(
                  `Error (Actualizaci√≥n) en tienda ID ${storeData.storeId} para producto ${productIdRappi}: ${putError.message}`
                );
                errorCount++;
                allSuccessful = false;
              }
            } else {
              // Otro error en POST que no es por "ya existe"
              associationResults.push(
                `Error (Nueva Asociaci√≥n) en tienda ID ${storeData.storeId} para producto ${productIdRappi}: ${postError.message}`
              );
              errorCount++;
              allSuccessful = false;
            }
          }
        }

        isAssociatingProduct = false;
        if (errorCount > 0) {
          setGlobalApiMessage(
            "error",
            `Asociaci√≥n completada con ${errorCount} error(es) y ${successCount} √©xito(s). Detalles: ${associationResults.join(
              "; "
            )}`
          );
        } else {
          setGlobalApiMessage(
            "success",
            `Asociaci√≥n completada con ${successCount} √©xito(s). Detalles: ${associationResults.join(
              "; "
            )}`
          );
        }

        if (allSuccessful) {
          closeAssociateModal();
        } else {
          renderAssociateModal();
        }
      }

      function applyOrderSearch() {
        if (!currentOrderSearchTerm) {
          displayedOrders = [...orders];
        } else {
          displayedOrders = orders.filter((order) =>
            order.id.toString().includes(currentOrderSearchTerm)
          );
        }
        displayedOrders.sort(
          (a, b) => new Date(b.created_at) - new Date(a.created_at)
        );
        renderAppOnly();
      }

      function handleOrderSearch() {
        currentOrderSearchTerm =
          document.getElementById("orderSearchInput")?.value || "";
        applyOrderSearch();
      }

      function clearOrderSearch() {
        currentOrderSearchTerm = "";
        const searchInput = document.getElementById("orderSearchInput");
        if (searchInput) searchInput.value = "";
        applyOrderSearch();
      }

      async function fetchOrders() {
        if (!accessToken) {
          setGlobalApiMessage("error", "Debes autenticarte primero.");
          return;
        }
        isLoadingOrders = true;
        if (!isPollingActive) clearGlobalMessages();
        renderAppOnly();
        const url = `${countryBaseUrls[selectedCountry]}/api/open-api/v1/orders`;
        try {
          const data = await makeApiCall(url);
          let newEventsReceived = 0;
          if (
            data === null ||
            (data &&
              typeof data === "object" &&
              !Array.isArray(data) &&
              Object.keys(data).length === 0)
          ) {
            if (orders.length === 0 && !isPollingActive)
              setGlobalApiMessage(
                "info",
                "No hay pedidos para mostrar (respuesta vac√≠a o nula)."
              );
          } else if (data && Array.isArray(data)) {
            newEventsReceived = data.length;
            data.forEach((newOrderData) => {
              const existingOrderIndex = orders.findIndex(
                (o) => o.id === newOrderData.id
              );
              if (existingOrderIndex > -1) {
                const existingOrder = orders[existingOrderIndex];
                const wasShowingDetails = existingOrder._showDetails;

                orders[existingOrderIndex] = {
                  ...existingOrder,
                  ...newOrderData,
                  event_uuid:
                    newOrderData.event_uuid || existingOrder.event_uuid,
                  _pickingStarted:
                    newOrderData.status !== "created"
                      ? existingOrder._pickingStarted ||
                        newOrderData.status === "picking_started_by_partner"
                      : false,
                  _invoiceReported:
                    newOrderData.status === "invoice_reported" ||
                    existingOrder._invoiceReported ||
                    newOrderData.status === "finished" ||
                    newOrderData.status === "canceled",
                  _courierRequested: existingOrder._courierRequested || false,
                  _courierAssigned:
                    newOrderData.courier && newOrderData.courier.first_name
                      ? true
                      : existingOrder._courierAssigned || false,
                  _handshakeStarted: existingOrder._handshakeStarted || false,
                  _handshakeCompleted:
                    newOrderData.status === "finished" ||
                    existingOrder._handshakeCompleted ||
                    false,
                  _substitutionStatuses:
                    existingOrder._substitutionStatuses || [],
                };

                if (wasShowingDetails && orders[existingOrderIndex]._details) {
                  orders[existingOrderIndex]._details.products =
                    newOrderData.products ||
                    orders[existingOrderIndex]._details.products;
                  orders[existingOrderIndex]._details.total_price =
                    newOrderData.total_price !== undefined
                      ? newOrderData.total_price
                      : orders[existingOrderIndex]._details.total_price;
                  orders[existingOrderIndex]._details.status =
                    newOrderData.status ||
                    orders[existingOrderIndex]._details.status;
                  orders[existingOrderIndex]._details.courier =
                    newOrderData.courier ||
                    orders[existingOrderIndex]._details.courier;
                  orders[existingOrderIndex]._details.event_uuid =
                    newOrderData.event_uuid ||
                    orders[existingOrderIndex]._details.event_uuid;
                  orders[existingOrderIndex]._details.delivered_at =
                    newOrderData.delivered_at ||
                    orders[existingOrderIndex]._details.delivered_at;
                  if (newOrderData.courier && newOrderData.courier.first_name) {
                    orders[existingOrderIndex]._details._courierAssigned = true;
                  }
                }
              } else {
                orders.unshift({
                  ...newOrderData,
                  _showDetails: false,
                  _details: null,
                  _isLoadingDetails: false,
                  event_uuid: newOrderData.event_uuid || null,
                  _pickingStarted:
                    newOrderData.status === "picking_started_by_partner",
                  _invoiceReported: newOrderData.status === "invoice_reported",
                  _courierRequested: false,
                  _courierAssigned: !!(
                    newOrderData.courier && newOrderData.courier.first_name
                  ),
                  _handshakeStarted: false,
                  _handshakeCompleted: newOrderData.status === "finished",
                  _substitutionStatuses: [],
                });
              }
            });
            if (newEventsReceived > 0 && isPollingActive) {
              showToast(
                `${newEventsReceived} evento(s) de pedido(s) recibido(s) por polling.`
              );
            } else if (newEventsReceived > 0 && !isPollingActive) {
              setGlobalApiMessage(
                "success",
                `Se recibieron ${newEventsReceived} eventos de pedidos.`
              );
            } else if (orders.length === 0 && !isPollingActive) {
              setGlobalApiMessage("info", "No hay pedidos nuevos.");
            }
          } else if (data && data.data && Array.isArray(data.data)) {
            newEventsReceived = data.data.length;
            data.data.forEach((newOrderData) => {
              const existingOrderIndex = orders.findIndex(
                (o) => o.id === newOrderData.id
              );
              if (existingOrderIndex > -1) {
                const existingOrder = orders[existingOrderIndex];
                const wasShowingDetails = existingOrder._showDetails;
                orders[existingOrderIndex] = {
                  ...existingOrder,
                  ...newOrderData,
                  event_uuid:
                    newOrderData.event_uuid || existingOrder.event_uuid,
                  _pickingStarted:
                    newOrderData.status !== "created"
                      ? existingOrder._pickingStarted ||
                        newOrderData.status === "picking_started_by_partner"
                      : false,
                  _invoiceReported:
                    newOrderData.status === "invoice_reported" ||
                    existingOrder._invoiceReported ||
                    newOrderData.status === "finished" ||
                    newOrderData.status === "canceled",
                  _courierRequested: existingOrder._courierRequested || false,
                  _courierAssigned:
                    newOrderData.courier && newOrderData.courier.first_name
                      ? true
                      : existingOrder._courierAssigned || false,
                  _handshakeStarted: existingOrder._handshakeStarted || false,
                  _handshakeCompleted:
                    newOrderData.status === "finished" ||
                    existingOrder._handshakeCompleted ||
                    false,
                  _substitutionStatuses:
                    existingOrder._substitutionStatuses || [],
                };
                if (wasShowingDetails && orders[existingOrderIndex]._details) {
                  if (newOrderData.products)
                    orders[existingOrderIndex]._details.products =
                      newOrderData.products;
                  if (newOrderData.total_price !== undefined)
                    orders[existingOrderIndex]._details.total_price =
                      newOrderData.total_price;
                  if (newOrderData.status)
                    orders[existingOrderIndex]._details.status =
                      newOrderData.status;
                  if (newOrderData.courier)
                    orders[existingOrderIndex]._details.courier =
                      newOrderData.courier;
                  if (newOrderData.event_uuid)
                    orders[existingOrderIndex]._details.event_uuid =
                      newOrderData.event_uuid;
                  if (newOrderData.delivered_at)
                    orders[existingOrderIndex]._details.delivered_at =
                      newOrderData.delivered_at;
                  if (newOrderData.courier && newOrderData.courier.first_name) {
                    orders[existingOrderIndex]._details._courierAssigned = true;
                  }
                }
              } else {
                orders.unshift({
                  ...newOrderData,
                  _showDetails: false,
                  _details: null,
                  _isLoadingDetails: false,
                  event_uuid: newOrderData.event_uuid || null,
                  _pickingStarted:
                    newOrderData.status === "picking_started_by_partner",
                  _invoiceReported: newOrderData.status === "invoice_reported",
                  _courierRequested: false,
                  _courierAssigned: !!(
                    newOrderData.courier && newOrderData.courier.first_name
                  ),
                  _handshakeStarted: false,
                  _handshakeCompleted: newOrderData.status === "finished",
                  _substitutionStatuses: [],
                });
              }
            });
            if (newEventsReceived > 0 && isPollingActive) {
              showToast(
                `${newEventsReceived} evento(s) de pedido(s) recibido(s) por polling.`
              );
            } else if (newEventsReceived > 0 && !isPollingActive) {
              setGlobalApiMessage(
                "success",
                `Se recibieron ${newEventsReceived} eventos de pedidos.`
              );
            } else if (orders.length === 0 && !isPollingActive) {
              setGlobalApiMessage("info", "No hay pedidos nuevos.");
            }
          } else {
            if (!isPollingActive)
              setGlobalApiMessage(
                "error",
                "No se pudieron cargar los pedidos o la respuesta no tiene el formato esperado. Revisa la consola y el visor JSON para m√°s detalles."
              );
            console.error("Respuesta de API de pedidos (inesperada):", data);
          }
        } catch (error) {
          if (!isPollingActive)
            setGlobalApiMessage(
              "error",
              `Error al cargar pedidos: ${error.message}`
            );
          else console.error("Error en polling de pedidos:", error.message);
        } finally {
          isLoadingOrders = false;
          if (isPollingActive) {
            timeToNextPoll = pollingFrequency;
          }
          applyOrderSearch();
        }
      }

      async function fetchOrderDetails(orderId, isInternalRefresh = false) {
        const orderIndex = orders.findIndex(
          (o) => o.id.toString() === orderId.toString()
        );
        if (orderIndex === -1) {
          if (!isInternalRefresh)
            setGlobalApiMessage(
              "error",
              "Pedido no encontrado en la lista local."
            );
          return null;
        }
        let order = orders[orderIndex];

        if (!accessToken) {
          if (!isInternalRefresh)
            setGlobalApiMessage("error", "Debes autenticarte primero.");
          return null;
        }

        order._isLoadingDetails = true;
        if (!isInternalRefresh) clearGlobalMessages();
        if (!isInternalRefresh) renderAppOnly();

        const url = `${countryBaseUrls[selectedCountry]}/api/open-api/v1/orders/${orderId}`;
        try {
          const data = await makeApiCall(url);
          orders[orderIndex]._details = data;
          if (data.event_uuid) {
            orders[orderIndex].event_uuid = data.event_uuid;
          }
          if (data.status) {
            orders[orderIndex].status = data.status;
            if (data.status === "invoice_reported")
              orders[orderIndex]._invoiceReported = true;
            else if (
              data.status !== "created" &&
              data.status !== "picking_started_by_partner"
            ) {
              orders[orderIndex]._invoiceReported = true;
            }
          }
          if (data.products) {
            orders[orderIndex].products = data.products;
          }
          orders[orderIndex]._courierAssigned = !!(
            data.courier && data.courier.first_name
          );
          if (data.status === "finished") {
            orders[orderIndex]._handshakeCompleted = true;
          }
        } catch (error) {
          if (!isInternalRefresh)
            setGlobalApiMessage(
              "error",
              `Error al cargar detalles del pedido ${orderId}: ${error.message}`
            );
          orders[orderIndex]._details = {
            error: `Error al cargar: ${error.message}`,
          };
        } finally {
          orders[orderIndex]._isLoadingDetails = false;
          if (!isInternalRefresh) renderAppOnly();
        }
        return orders[orderIndex]._details;
      }

      async function toggleOrderDetails(orderId) {
        const orderIndex = orders.findIndex(
          (o) => o.id.toString() === orderId.toString()
        );
        if (orderIndex === -1) return;

        orders[orderIndex]._showDetails = !orders[orderIndex]._showDetails;

        if (
          orders[orderIndex]._showDetails &&
          (!orders[orderIndex]._details || orders[orderIndex]._details.error)
        ) {
          await fetchOrderDetails(orderId);
        } else {
          renderAppOnly();
        }
      }

      async function performOrderAction(
        orderId,
        actionPath,
        payload = null,
        successMessage,
        httpMethod = "POST"
      ) {
        let orderIndex = orders.findIndex(
          (o) => o.id.toString() === orderId.toString()
        );
        if (orderIndex === -1) {
          setGlobalApiMessage("error", "Pedido no encontrado para la acci√≥n.");
          return;
        }
        let orderRef = orders[orderIndex];

        orderActionInProgress = true;
        orderRef._isLoadingDetails = true;
        clearGlobalMessages();
        renderAppOnly();

        console.log(
          `[performOrderAction] Iniciando acci√≥n: '${actionPath}', Pedido: ${orderId}. Refrescando detalles primero...`
        );
        await fetchOrderDetails(orderId, true);

        orderIndex = orders.findIndex(
          (o) => o.id.toString() === orderId.toString()
        );
        if (orderIndex === -1) {
          orderActionInProgress = false;
          renderAppOnly();
          return;
        }
        orderRef = orders[orderIndex];

        if (
          !orderRef ||
          !orderRef._details ||
          !orderRef._details.event_uuid ||
          orderRef._details.error
        ) {
          setGlobalApiMessage(
            "error",
            `No se pudo obtener el event_uuid o hubo un error al refrescar detalles para la acci√≥n '${actionPath}'. Event UUID: ${
              orderRef?._details?.event_uuid
            }. Detalles: ${JSON.stringify(
              orderRef?._details
            )}. Intenta de nuevo.`
          );
          orderActionInProgress = false;
          if (orderRef) orderRef._isLoadingDetails = false;
          renderAppOnly();
          return;
        }

        const currentEventUuid = orderRef._details.event_uuid;
        const actionUrl = `${countryBaseUrls[selectedCountry]}/api/open-api/v1/orders/${orderId}/${actionPath}`;
        const headers = { event_uuid: currentEventUuid };

        console.log(
          `[performOrderAction] Enviando ${httpMethod} a: ${actionUrl}`
        );
        if (payload)
          console.log(
            `[performOrderAction] Payload:`,
            JSON.stringify(payload, null, 2)
          );
        console.log(
          `[performOrderAction] Headers:`,
          JSON.stringify(headers, null, 2)
        );

        try {
          const responseAction = await makeApiCall(
            actionUrl,
            httpMethod,
            payload,
            true,
            headers
          );
          setGlobalApiMessage(
            "success",
            `${successMessage} para pedido ${orderId}. Refrescando detalles...`
          );

          if (actionPath === "start_picking") {
            orders[orderIndex]._pickingStarted = true;
          } else if (actionPath === "report_invoice") {
            orders[orderIndex]._invoiceReported = true;
          } else if (actionPath === "request_courier") {
            orders[orderIndex]._courierRequested = true;
          } else if (
            actionPath === "handshake" &&
            responseAction &&
            responseAction.codes
          ) {
            orders[orderIndex]._handshakeStarted = true;
          }

          await fetchOrderDetails(orderId, true);
          if (
            actionPath.includes("cancel") ||
            actionPath.includes("finish") ||
            actionPath.startsWith("products/")
          ) {
            await fetchOrders();
          }
          return responseAction;
        } catch (error) {
          setGlobalApiMessage(
            "error",
            `Error en acci√≥n '${actionPath}' para pedido ${orderId}: ${error.message}`
          );
          console.error(
            `Error en acci√≥n ${actionPath} para pedido ${orderId}:`,
            error
          );
          await fetchOrderDetails(orderId, true).catch((e) =>
            console.error(
              "Error al refrescar detalles post-fallo de acci√≥n:",
              e
            )
          );
          throw error;
        } finally {
          orderActionInProgress = false;
          renderAppOnly();
        }
      }

      async function startPickingOrder(orderId) {
        const pickingTime = 15;
        console.log(
          `[startPickingOrder] Order ID: ${orderId}, Picking Time (hardcoded): ${pickingTime}`
        );
        if (isNaN(pickingTime) || pickingTime <= 0) {
          setGlobalApiMessage("info", "Tiempo de picking inv√°lido.");
          console.log("[startPickingOrder] Tiempo de picking inv√°lido.");
          return;
        }
        await performOrderAction(
          orderId,
          "start_picking",
          { picking_time: pickingTime },
          "Picking iniciado"
        );
      }

      async function reportOrderInvoice(orderId) {
        const totalPrice = 120.5;
        console.log(
          `[reportOrderInvoice] Order ID: ${orderId}, Total Price (hardcoded): ${totalPrice}`
        );

        if (isNaN(totalPrice) || totalPrice < 0) {
          setGlobalApiMessage("info", "Precio total inv√°lido.");
          console.log("[reportOrderInvoice] Precio total inv√°lido.");
          return;
        }
        const imageUrl = "";
        console.log(`[reportOrderInvoice] Image URL (hardcoded): ${imageUrl}`);
        await performOrderAction(
          orderId,
          "report_invoice",
          { total_price: totalPrice, image_url: imageUrl || null },
          "Factura reportada"
        );
      }

      async function cancelOrder(orderId) {
        const reason = "technical_issues";
        console.log(
          `[cancelOrder] Order ID: ${orderId}, Reason (hardcoded): ${reason}`
        );

        if (!reason) {
          setGlobalApiMessage(
            "info",
            "Motivo de cancelaci√≥n no proporcionado."
          );
          console.log("[cancelOrder] Motivo no proporcionado.");
          return;
        }
        await performOrderAction(
          orderId,
          "cancel",
          { type: reason, details: {} },
          "Pedido cancelado"
        );
      }

      function updatePollingCountdown() {
        const countdownEl = document.getElementById("pollingCountdown");
        if (isPollingActive && countdownEl) {
          timeToNextPoll -= 1000;
          if (timeToNextPoll < 0) timeToNextPoll = pollingFrequency;
          countdownEl.textContent = `Pr√≥ximo refresco en: ${Math.ceil(
            timeToNextPoll / 1000
          )} seg.`;
        } else if (countdownEl) {
          countdownEl.textContent = "";
        }
      }

      function startPolling() {
        if (isPollingActive) return;
        isPollingActive = true;
        pollingFrequency = parseInt(
          document.getElementById("pollingFrequencySelect").value
        );
        setGlobalApiMessage(
          "info",
          `Polling iniciado cada ${pollingFrequency / 1000} segundos.`
        );
        fetchOrders();
        pollingIntervalId = setInterval(fetchOrders, pollingFrequency);
        timeToNextPoll = pollingFrequency;
        if (pollingCountdownIntervalId)
          clearInterval(pollingCountdownIntervalId);
        pollingCountdownIntervalId = setInterval(updatePollingCountdown, 1000);
        renderAppOnly();
      }

      function stopPolling() {
        if (!isPollingActive) return;
        isPollingActive = false;
        clearInterval(pollingIntervalId);
        pollingIntervalId = null;
        clearInterval(pollingCountdownIntervalId);
        pollingCountdownIntervalId = null;
        timeToNextPoll = 0;
        setGlobalApiMessage("info", "Polling detenido.");
        renderAppOnly();
      }

      function openRequestCourierModal(orderId) {
        const order = orders.find(
          (o) => o.id.toString() === orderId.toString()
        );
        if (!order) {
          setGlobalApiMessage("error", "Pedido no encontrado.");
          return;
        }
        orderToRequestCourier = order;
        selectedVehicleTypeForCourier = "motorbike";
        showRequestCourierModal = true;
        clearGlobalMessages();
        renderRequestCourierModal();
        requestCourierModalEl.classList.add("active");
      }

      function closeRequestCourierModal() {
        showRequestCourierModal = false;
        orderToRequestCourier = null;
        requestCourierModalEl.classList.remove("active");
        renderAppOnly();
      }

      async function handleRequestCourierConfirm() {
        if (!orderToRequestCourier || !orderToRequestCourier.store?.id) {
          setGlobalApiMessage(
            "error",
            "Falta informaci√≥n del pedido o ID de tienda para solicitar mensajero."
          );
          closeRequestCourierModal();
          return;
        }
        isRequestingCourier = true;
        renderRequestCourierModal();

        const payload = {
          store_id: parseInt(orderToRequestCourier.store.id),
          vehicle_type: selectedVehicleTypeForCourier,
        };
        try {
          await performOrderAction(
            orderToRequestCourier.id,
            "request_courier",
            payload,
            "Solicitud de RT enviada"
          );
          if (!apiGlobalErrorMessage && !apiGlobalInfoMessage) {
            closeRequestCourierModal();
          }
        } catch (error) {
          // El error ya es manejado por performOrderAction
        } finally {
          isRequestingCourier = false;
          if (showRequestCourierModal) {
            renderRequestCourierModal();
          }
        }
      }

      function openHandshakeModal(orderId) {
        const order = orders.find(
          (o) => o.id.toString() === orderId.toString()
        );
        if (!order) {
          setGlobalApiMessage("error", "Pedido no encontrado.");
          return;
        }
        orderForHandshake = order;
        handshakeCodes = [];
        handshakeExpiresAt = null;
        codeToValidateByRT = "";
        handshakeMessage = "";
        showHandshakeModal = true;
        clearGlobalMessages();
        renderHandshakeModal();
        handshakeModalEl.classList.add("active");
      }

      function closeHandshakeModal() {
        showHandshakeModal = false;
        orderForHandshake = null;
        handshakeModalEl.classList.remove("active");
        renderAppOnly();
      }

      async function handleRequestHandshakeCodes() {
        if (!orderForHandshake) return;
        isRequestingHandshakeCodes = true;
        handshakeMessage = "Solicitando c√≥digos...";
        renderHandshakeModal();

        try {
          const data = await performOrderAction(
            orderForHandshake.id,
            "handshake",
            null,
            "C√≥digos de handshake solicitados",
            "POST"
          );
          if (data && data.codes && data.expires_at) {
            handshakeCodes = data.codes;
            handshakeExpiresAt = new Date(data.expires_at).toLocaleString();
            handshakeMessage = `C√≥digos obtenidos. Expiran: ${handshakeExpiresAt}. Dile al RT que elija uno.`;
            const orderIndex = orders.findIndex(
              (o) => o.id === orderForHandshake.id
            );
            if (orderIndex > -1) orders[orderIndex]._handshakeStarted = true;
          } else {
            handshakeMessage =
              "Error al obtener c√≥digos o respuesta inesperada.";
          }
        } catch (error) {
          handshakeMessage = `Error al solicitar c√≥digos: ${error.message}`;
        } finally {
          isRequestingHandshakeCodes = false;
          renderHandshakeModal();
        }
      }

      async function handleValidateHandshakeCode() {
        if (!orderForHandshake || !codeToValidateByRT) {
          handshakeMessage = "Ingresa el c√≥digo proporcionado por el RT.";
          renderHandshakeModal();
          return;
        }
        isValidatingHandshakeCode = true;
        handshakeMessage = "Validando c√≥digo...";
        renderHandshakeModal();

        try {
          const orderId = orderForHandshake.id;
          const orderRef = orders.find(
            (o) => o.id.toString() === orderId.toString()
          );
          if (
            !orderRef ||
            !orderRef._details ||
            !orderRef._details.event_uuid
          ) {
            throw new Error("Falta event_uuid para validar handshake.");
          }
          const currentEventUuid = orderRef._details.event_uuid;
          const actionUrl = `${countryBaseUrls[selectedCountry]}/api/open-api/v1/orders/${orderId}/handshake/validate`;
          const headers = { event_uuid: currentEventUuid };

          const result = await makeApiCall(
            actionUrl,
            "POST",
            { code: codeToValidateByRT },
            true,
            headers
          );

          if (result && result.success && result.status === 204) {
            handshakeMessage =
              "¬°C√≥digo validado exitosamente! Puedes entregar el pedido.";
            showToast("Handshake exitoso!");
            const orderIndex = orders.findIndex((o) => o.id === orderId);
            if (orderIndex > -1) orders[orderIndex]._handshakeCompleted = true;
            await fetchOrderDetails(orderId, true);
            closeHandshakeModal();
          } else {
            handshakeMessage =
              "Respuesta inesperada del servidor al validar c√≥digo.";
          }
        } catch (error) {
          if (
            error.message.includes("400") &&
            error.message.toLowerCase().includes("invalid_handshake_code")
          ) {
            let retriesMsg = "";
            try {
              const errorDetailsMatch = error.message.match(/{.*}/s);
              if (errorDetailsMatch) {
                const errorJson = JSON.parse(errorDetailsMatch[0]);
                if (
                  errorJson.details &&
                  errorJson.details.retries_left !== undefined
                ) {
                  retriesMsg = ` Intentos restantes: ${errorJson.details.retries_left}.`;
                }
              }
            } catch (parseErr) {
              /* no hacer nada */
            }
            handshakeMessage = `C√≥digo inv√°lido.${retriesMsg} Pide al RT que verifique e intente de nuevo.`;
          } else {
            handshakeMessage = `Error al validar c√≥digo: ${error.message}`;
          }
        } finally {
          isValidatingHandshakeCode = false;
          renderHandshakeModal();
        }
      }

      function openConfirmRemoveProductModal(
        orderId,
        productId,
        productName,
        orderProductId
      ) {
        orderProductToRemove = {
          orderId,
          productId,
          productName,
          order_product_id: orderProductId,
        };
        showRemoveProductModal = true;
        clearGlobalMessages();
        renderConfirmRemoveProductModal();
        confirmRemoveProductModalEl.classList.add("active");
      }

      function closeConfirmRemoveProductModal() {
        showRemoveProductModal = false;
        orderProductToRemove = null;
        confirmRemoveProductModalEl.classList.remove("active");
        renderAppOnly();
      }

      async function confirmRemoveProductFromOrder() {
        if (!orderProductToRemove) return;
        isRemovingProductFromOrder = true;
        renderConfirmRemoveProductModal();

        const { orderId, productId, productName } = orderProductToRemove;

        const orderRef = orders.find(
          (o) => o.id.toString() === orderId.toString()
        );
        if (!orderRef || !orderRef._details || !orderRef._details.event_uuid) {
          setGlobalApiMessage(
            "error",
            `No se pudo obtener event_uuid para eliminar producto del pedido ${orderId}. Refresca los detalles.`
          );
          isRemovingProductFromOrder = false;
          closeConfirmRemoveProductModal();
          return;
        }
        const currentEventUuid = orderRef._details.event_uuid;
        const headers = { event_uuid: currentEventUuid };

        const url = `${countryBaseUrls[selectedCountry]}/api/open-api/v1/orders/${orderId}/products/${productId}`;
        try {
          await makeApiCall(url, "DELETE", null, true, headers);
          setGlobalApiMessage(
            "success",
            `Producto "${productName}" eliminado del pedido ${orderId}.`
          );
          await fetchOrderDetails(orderId, true);
          await fetchOrders();
        } catch (error) {
          setGlobalApiMessage(
            "error",
            `Error al eliminar producto "${productName}" del pedido ${orderId}: ${error.message}`
          );
        } finally {
          isRemovingProductFromOrder = false;
          closeConfirmRemoveProductModal();
        }
      }

      // --- Funciones para Sustituci√≥n de Productos ---
      function openSubstituteModal(
        orderId,
        originalProductId,
        originalProductName,
        userPreferenceString
      ) {
        const order = orders.find(
          (o) => o.id.toString() === orderId.toString()
        );
        if (!order) {
          setGlobalApiMessage(
            "error",
            "Pedido no encontrado para sustituci√≥n."
          );
          return;
        }

        // Verificar si el picking ha comenzado
        if (
          !order._pickingStarted &&
          order.status !== "picking_started_by_partner"
        ) {
          showToast(
            "La sustituci√≥n solo es posible despu√©s de iniciar el picking."
          );
          return;
        }
        // Verificar si la factura ya fue reportada o el pedido est√° finalizado/cancelado
        if (
          order._invoiceReported ||
          order.status === "finished" ||
          order.status === "canceled"
        ) {
          showToast(
            "No se puede sustituir productos en este estado del pedido."
          );
          return;
        }

        let parsedUserPreference = null;
        if (
          userPreferenceString &&
          userPreferenceString !== "undefined" &&
          userPreferenceString !== "null"
        ) {
          try {
            parsedUserPreference = JSON.parse(userPreferenceString);
          } catch (e) {
            if (
              ["refund", "shopper_chooses", "user_chooses"].includes(
                userPreferenceString
              )
            ) {
              parsedUserPreference = { action: userPreferenceString };
            } else {
              console.warn(
                "No se pudo parsear userPreference o no es una acci√≥n v√°lida:",
                userPreferenceString
              );
            }
          }
        }

        orderForSubstitution = order;
        productToSubstituteDetails = {
          originalProductId,
          originalProductName,
          userPreference: parsedUserPreference,
        };

        substituteProductData = {
          id:
            parsedUserPreference?.action === "user_chooses" &&
            parsedUserPreference.preferred_product
              ? parsedUserPreference.preferred_product.id.toString()
              : "",
          name:
            parsedUserPreference?.action === "user_chooses" &&
            parsedUserPreference.preferred_product
              ? parsedUserPreference.preferred_product.name
              : "",
          units: 1,
          weight_units: null,
        };
        substituteCatalogSearchTerm = "";
        substituteCatalogSearchResults = [];

        showSubstituteModal = true;
        clearGlobalMessages();
        renderSubstituteProductModal();
        substituteProductModalEl.classList.add("active");
      }

      function closeSubstituteModal() {
        showSubstituteModal = false;
        orderForSubstitution = null;
        productToSubstituteDetails = null;
        substituteProductData = {
          id: "",
          name: "",
          units: 1,
          weight_units: null,
        };
        isInitiatingSubstitution = false;
        substituteCatalogSearchTerm = "";
        substituteCatalogSearchResults = [];
        substituteProductModalEl.innerHTML = "";
        substituteProductModalEl.classList.remove("active");
        renderAppOnly();
      }

      function handleSubstituteCatalogSearch() {
        substituteCatalogSearchTerm =
          document
            .getElementById("substituteCatalogSearchInput")
            ?.value.toLowerCase() || "";
        if (!substituteCatalogSearchTerm) {
          substituteCatalogSearchResults = [];
        } else {
          substituteCatalogSearchResults = allCatalogProducts
            .filter(
              (p) =>
                (p.name &&
                  p.name.toLowerCase().includes(substituteCatalogSearchTerm)) ||
                (p.sku &&
                  p.sku.toLowerCase().includes(substituteCatalogSearchTerm))
            )
            .slice(0, 20);
        }
        renderSubstituteProductModal();
        // Re-focus
        const searchInputEl = document.getElementById(
          "substituteCatalogSearchInput"
        );
        if (searchInputEl) {
          searchInputEl.focus();
          // Mover cursor al final
          const val = searchInputEl.value;
          searchInputEl.value = "";
          searchInputEl.value = val;
        }
      }

      function selectSubstituteProduct(productId, productName) {
        substituteProductData.id = productId.toString();
        substituteProductData.name = productName;
        substituteCatalogSearchResults = [];
        substituteCatalogSearchTerm = "";
        renderSubstituteProductModal();
        document.getElementById("substituteProductId").value = productId;
        document.getElementById(
          "substituteProductNameDisplay"
        ).textContent = `Seleccionado: ${productName} (ID: ${productId})`;
        // Re-focus el input de unidades despu√©s de seleccionar un producto
        const unitsInputEl = document.getElementById("substituteProductUnits");
        if (unitsInputEl) {
          unitsInputEl.focus();
        }
      }

      async function handleInitiateSubstitution() {
        if (
          !orderForSubstitution ||
          !productToSubstituteDetails ||
          !substituteProductData.id ||
          substituteProductData.units <= 0
        ) {
          setGlobalApiMessage(
            "error",
            "Datos incompletos para iniciar sustituci√≥n. Se requiere ID de producto sustituto y unidades > 0."
          );
          renderSubstituteProductModal();
          return;
        }
        // Doble chequeo de estado antes de enviar
        if (
          !orderForSubstitution._pickingStarted &&
          orderForSubstitution.status !== "picking_started_by_partner"
        ) {
          showToast(
            "La sustituci√≥n solo es posible despu√©s de iniciar el picking."
          );
          isInitiatingSubstitution = false; // Resetear estado de carga
          renderSubstituteProductModal();
          return;
        }
        if (
          orderForSubstitution._invoiceReported ||
          orderForSubstitution.status === "finished" ||
          orderForSubstitution.status === "canceled"
        ) {
          showToast(
            "No se puede sustituir productos en este estado del pedido (facturado, finalizado o cancelado)."
          );
          isInitiatingSubstitution = false;
          renderSubstituteProductModal();
          return;
        }

        isInitiatingSubstitution = true;
        renderSubstituteProductModal();

        const orderId = orderForSubstitution.id;
        const originalProductId = productToSubstituteDetails.originalProductId;

        const orderRef = orders.find(
          (o) => o.id.toString() === orderId.toString()
        );
        if (!orderRef || !orderRef._details || !orderRef._details.event_uuid) {
          setGlobalApiMessage(
            "error",
            `No se pudo obtener event_uuid para sustituir producto del pedido ${orderId}. Refresca los detalles.`
          );
          isInitiatingSubstitution = false;
          renderSubstituteProductModal();
          return;
        }
        const currentEventUuid = orderRef._details.event_uuid;
        const headers = { event_uuid: currentEventUuid };

        const payload = {
          id: parseInt(substituteProductData.id),
          units: parseInt(substituteProductData.units),
        };
        if (
          substituteProductData.weight_units !== null &&
          !isNaN(parseFloat(substituteProductData.weight_units))
        ) {
          payload.weight_units = parseFloat(substituteProductData.weight_units);
        }

        const url = `${countryBaseUrls[selectedCountry]}/api/open-api/v1/orders/${orderId}/products/${originalProductId}/substitution`;
        try {
          await makeApiCall(url, "POST", payload, true, headers);
          showToast(
            `Propuesta de sustituci√≥n para "${productToSubstituteDetails.originalProductName}" enviada.`
          );
          await fetchOrderDetails(orderId, true);
          await fetchSubstitutionStatuses(orderId);
          closeSubstituteModal();
        } catch (error) {
          console.error("Error al iniciar sustituci√≥n:", error);
        } finally {
          isInitiatingSubstitution = false;
          if (showSubstituteModal) {
            renderSubstituteProductModal();
          }
        }
      }

      async function fetchSubstitutionStatuses(orderId) {
        const orderIndex = orders.findIndex(
          (o) => o.id.toString() === orderId.toString()
        );
        if (orderIndex === -1) {
          setGlobalApiMessage(
            "error",
            "Pedido no encontrado para ver estado de sustituciones."
          );
          return;
        }

        isLoadingSubstitutionStatuses = true;
        orders[orderIndex]._substitutionStatuses = [];
        if (orders[orderIndex]._showDetails) {
          const accordionContentEl = document.querySelector(
            `#details-for-order-${orderId} > td`
          );
          if (accordionContentEl)
            accordionContentEl.innerHTML = renderOrderDetailsAccordionContent(
              orders[orderIndex]
            );
        } else {
          renderAppOnly();
        }

        const url = `${countryBaseUrls[selectedCountry]}/api/open-api/v1/orders/${orderId}/product_status`;
        try {
          const data = await makeApiCall(url, "GET");
          if (data && data.substitutions && Array.isArray(data.substitutions)) {
            orders[orderIndex]._substitutionStatuses = data.substitutions;
            if (data.substitutions.length === 0) {
              showToast(
                "No hay propuestas de sustituci√≥n activas para este pedido."
              );
            } else {
              showToast(
                `Estado de ${data.substitutions.length} sustitucion(es) cargado.`
              );
            }
          } else {
            showToast(
              "No se encontraron estados de sustituci√≥n o formato de respuesta inesperado."
            );
            orders[orderIndex]._substitutionStatuses = [];
          }
        } catch (error) {
          setGlobalApiMessage(
            "error",
            `Error al cargar estado de sustituciones: ${error.message}`
          );
          orders[orderIndex]._substitutionStatuses = [{ error: error.message }];
        } finally {
          isLoadingSubstitutionStatuses = false;
          if (orders[orderIndex]._showDetails) {
            const accordionContentEl = document.querySelector(
              `#details-for-order-${orderId} > td`
            );
            if (accordionContentEl) {
              accordionContentEl.innerHTML = renderOrderDetailsAccordionContent(
                orders[orderIndex]
              );
              attachOrderActionListeners(`#details-for-order-${orderId}`);
            }
          } else {
            renderAppOnly();
          }
        }
      }

      function renderCreateProductModal() {
        if (!showCreateProductModal) {
          createProductModalEl.innerHTML = "";
          createProductModalEl.classList.remove("active");
          return;
        }

        let variationsHtml = "";
        if (newProduct.has_variation) {
          variationsHtml = newProduct.variations
            .map(
              (variation, index) => `
                    <div class="variation-block">
                        <h4>Variaci√≥n ${
                          index + 1
                        } <button type="button" class="btn btn-link-danger btn-sm remove-variation-btn" data-index="${index}" style="font-size:0.7em; padding:0.1em 0.3em; margin-left:5px;" ${
                newProduct.variations.length === 1 ? "disabled" : ""
              }>Eliminar</button></h4>
                        <div class="form-group"><label for="varSku_${index}">SKU Variaci√≥n: <span class="text-red-500">*</span></label><input type="text" id="varSku_${index}" class="input-field var-sku" data-index="${index}" value="${
                variation.sku
              }"></div>
                        <div class="form-group"><label for="varName_${index}">Nombre Variaci√≥n: <span class="text-red-500">*</span></label><input type="text" id="varName_${index}" class="input-field var-name" data-index="${index}" value="${
                variation.name
              }"></div>
                        <div class="form-group"><label for="varEan_${index}">EAN Variaci√≥n: <span class="text-red-500">*</span></label><input type="text" id="varEan_${index}" class="input-field var-ean" data-index="${index}" value="${
                variation.ean
              }" placeholder="Puede ser 'NULL'"></div>
                        <div class="form-group"><label for="varImgUrl_${index}">URL Imagen Variaci√≥n:</label><input type="text" id="varImgUrl_${index}" class="input-field var-img-url" data-index="${index}" value="${
                variation.images[0]?.path || ""
              }"></div>
                        
                        <div class="form-group">
                            <label>Atributos para Variaci√≥n ${
                              index + 1
                            }:</label>
                            <div id="variationAttributesContainer_${index}" class="attributes-container">
                                ${
                                  availableAttributes.length > 0
                                    ? availableAttributes
                                        .map(
                                          (attr) => `
                                    <div class="attribute-item">
                                        <label for="var_attr_${
                                          attr.code
                                        }_${index}">${attr.name} (${
                                            attr.code
                                          }):</label>
                                        <input type="text" id="var_attr_${
                                          attr.code
                                        }_${index}" class="input-field input-field-sm var-attribute-value" data-index="${index}" data-attr-code="${
                                            attr.code
                                          }" value="${
                                            variation.attributes[attr.code] ||
                                            ""
                                          }">
                                    </div>
                                `
                                        )
                                        .join("")
                                    : '<p class="text-xs">Cargue atributos desde la secci√≥n principal del producto para ver opciones.</p>'
                                }
                            </div>
                        </div>
                    </div>
                `
            )
            .join("");
        }

        createProductModalEl.innerHTML = `
                <div class="modal-content" style="max-width: 700px;"> <div class="modal-header"><h3>Crear Nuevo Producto</h3><button id="closeCreateModalBtn" class="close-btn">&times;</button></div>
                    <form id="createProductForm">
                        <div class="form-group"><label for="newProdName">Nombre Principal Producto: <span class="text-red-500">*</span></label><input type="text" id="newProdName" class="input-field" value="${
                          newProduct.name
                        }"></div>
                        <div class="form-group"><label for="newProdDesc">Descripci√≥n Principal:</label><textarea id="newProdDesc" class="input-field">${
                          newProduct.description
                        }</textarea></div>
                        
                        <div class="form-group">
                            <label for="newProdCatId">ID Categor√≠a (Rappi): <span class="text-red-500">*</span></label>
                            <div class="flex gap-2 items-center">
                                <input type="text" id="newProdCatId" class="input-field" value="${
                                  newProduct.category_id
                                }" placeholder="Selecciona del √°rbol o ingresa ID">
                                <button type="button" id="loadCategoryTreeBtnCreate" class="btn btn-secondary text-xs ${
                                  isLoadingCategoryTree ? "opacity-50" : ""
                                }" ${
          isLoadingCategoryTree ? "disabled" : ""
        } style="white-space:nowrap;">${
          isLoadingCategoryTree ? "Cargando..." : "Ver √Årbol"
        }</button>
                                <button type="button" id="loadAttributesBtnCreate" class="btn btn-info text-xs ${
                                  isLoadingAttributes || !newProduct.category_id
                                    ? "opacity-50"
                                    : ""
                                }" ${
          isLoadingAttributes || !newProduct.category_id ? "disabled" : ""
        } style="white-space:nowrap;">${
          isLoadingAttributes ? "Cargando..." : "Cargar Atributos Cat."
        }</button>
                            </div>
                            <div id="categoryTreeContainer" class="mt-2 scrollable-list text-xs" style="display: ${
                              categoryTreeData ? "block" : "none"
                            };">${
          categoryTreeData ? renderCategoryTreeNode(categoryTreeData) : ""
        }</div>
                        </div>
                        
                        <div class="form-group">
                            <label class="flex items-center"><input type="checkbox" id="hasVariationCheckbox" class="mr-2" ${
                              newProduct.has_variation ? "checked" : ""
                            }> Tiene Variaciones?</label>
                        </div>

                        <div id="singleProductFields" style="display: ${
                          newProduct.has_variation ? "none" : "block"
                        };">
                            <div class="grid grid-cols-2 gap-4">
                                <div class="form-group"><label for="newProdSku">SKU: <span class="text-red-500">*</span></label><input type="text" id="newProdSku" class="input-field" value="${
                                  newProduct.sku
                                }"></div>
                                <div class="form-group"><label for="newProdEan">EAN: <span class="text-red-500">*</span></label><input type="text" id="newProdEan" class="input-field" value="${
                                  newProduct.ean
                                }" placeholder="Puede ser 'NULL'"></div>
                                <div class="form-group"><label for="newProdPresQty">Cant. Presentaci√≥n: <span class="text-red-500">*</span></label><input type="number" id="newProdPresQty" class="input-field" value="${
                                  newProduct.presentation_quantity
                                }" min="0.01" step="any"></div>
                                <div class="form-group"><label for="newProdPresUnit">Unidad Presentaci√≥n: <span class="text-red-500">*</span></label>
                                    <select id="newProdPresUnit" class="input-field">
                                        <option value="Und" ${
                                          newProduct.presentation_unit_type ===
                                          "Und"
                                            ? "selected"
                                            : ""
                                        }>Und</option> <option value="Kg" ${
          newProduct.presentation_unit_type === "Kg" ? "selected" : ""
        }>Kg</option>
                                        <option value="g" ${
                                          newProduct.presentation_unit_type ===
                                          "g"
                                            ? "selected"
                                            : ""
                                        }>g</option> <option value="mg" ${
          newProduct.presentation_unit_type === "mg" ? "selected" : ""
        }>mg</option>
                                        <option value="L" ${
                                          newProduct.presentation_unit_type ===
                                          "L"
                                            ? "selected"
                                            : ""
                                        }>L</option> <option value="mL" ${
          newProduct.presentation_unit_type === "mL" ? "selected" : ""
        }>mL</option>
                                    </select>
                                </div>
                                <div class="form-group md-col-span-2"><label for="newProdImgUrl">URL Imagen Principal:</label><input type="text" id="newProdImgUrl" class="input-field" value="${
                                  newProduct.images[0].path
                                }"></div>
                            </div>
                             <div class="form-group mt-2">
                                <label>Atributos para Producto Principal (si no tiene variaciones):</label>
                                <div id="newProdAttributesContainer" class="attributes-container">
                                    ${
                                      availableAttributes.length > 0
                                        ? availableAttributes
                                            .map(
                                              (attr) => `
                                        <div class="attribute-item">
                                            <label for="attr_${attr.code}">${
                                                attr.name
                                              } (${attr.code}):</label>
                                            <input type="text" id="attr_${
                                              attr.code
                                            }" class="input-field input-field-sm main-attribute-value" data-attr-code="${
                                                attr.code
                                              }" value="${
                                                newProduct.attributes[
                                                  attr.code
                                                ] || ""
                                              }">
                                        </div>
                                    `
                                            )
                                            .join("")
                                        : '<p class="text-xs">Cargue atributos usando el bot√≥n de arriba si esta categor√≠a los requiere.</p>'
                                    }
                                </div>
                            </div>
                        </div>

                        <div id="variationsContainer" style="display: ${
                          newProduct.has_variation ? "block" : "none"
                        };">
                            ${variationsHtml}
                            <button type="button" id="addVariationBtn" class="btn btn-secondary btn-sm mt-2">A√±adir Variaci√≥n</button>
                        </div>
                        
                        <div class="modal-footer">
                            <button type="button" id="cancelCreateModalBtn" class="btn btn-secondary">Cancelar</button>
                            <button type="submit" class="btn btn-primary ${
                              isSubmittingProduct ? "opacity-50" : ""
                            }" ${isSubmittingProduct ? "disabled" : ""}>${
          isSubmittingProduct ? "Creando..." : "Crear Producto"
        }</button>
                        </div>
                    </form>
                </div>`;

        // Event listeners para el modal de creaci√≥n
        document
          .getElementById("createProductForm")
          ?.addEventListener("submit", (e) => handleCreateProduct(e));
        document
          .getElementById("closeCreateModalBtn")
          ?.addEventListener("click", closeCreateProductModal);
        document
          .getElementById("cancelCreateModalBtn")
          ?.addEventListener("click", closeCreateProductModal);

        // Listeners para campos principales
        document
          .getElementById("newProdName")
          .addEventListener("input", (e) => (newProduct.name = e.target.value));
        document
          .getElementById("newProdDesc")
          .addEventListener(
            "input",
            (e) => (newProduct.description = e.target.value)
          );
        document
          .getElementById("newProdCatId")
          .addEventListener("input", (e) => {
            newProduct.category_id = e.target.value;
            availableAttributes = []; // Limpiar atributos si cambia la categor√≠a manualmente
            renderCreateProductModal(); // Re-render para actualizar estado del bot√≥n de atributos
          });
        document
          .getElementById("loadCategoryTreeBtnCreate")
          ?.addEventListener("click", () =>
            fetchCategoryTree("newProdCatId", newProduct, "create")
          );
        document
          .getElementById("loadAttributesBtnCreate")
          ?.addEventListener("click", () => {
            if (newProduct.category_id)
              fetchCategoryAttributes(newProduct.category_id, "create");
            else
              showToast(
                "Por favor, ingresa o selecciona un ID de categor√≠a primero."
              );
          });

        document
          .getElementById("hasVariationCheckbox")
          .addEventListener("change", (e) => {
            newProduct.has_variation = e.target.checked;
            if (
              newProduct.has_variation &&
              newProduct.variations.length === 0
            ) {
              // Asegurar al menos una variaci√≥n si se marca
              newProduct.variations.push({
                sku: "",
                ean: "",
                name: "",
                images: [
                  {
                    path: "https://placehold.co/600x400/00FF00/FFFFFF.png?text=VariacionNueva",
                    position: 1,
                  },
                ],
                attributes: {},
              });
            }
            renderCreateProductModal(); // Re-render para mostrar/ocultar campos
          });

        // Listeners para campos de producto √∫nico (si no hay variaciones)
        if (!newProduct.has_variation) {
          document
            .getElementById("newProdSku")
            .addEventListener(
              "input",
              (e) => (newProduct.sku = e.target.value)
            );
          document
            .getElementById("newProdEan")
            .addEventListener(
              "input",
              (e) => (newProduct.ean = e.target.value)
            );
          document
            .getElementById("newProdPresQty")
            .addEventListener(
              "input",
              (e) =>
                (newProduct.presentation_quantity =
                  parseFloat(e.target.value) || 1)
            );
          document
            .getElementById("newProdPresUnit")
            .addEventListener(
              "change",
              (e) => (newProduct.presentation_unit_type = e.target.value)
            );
          document
            .getElementById("newProdImgUrl")
            .addEventListener(
              "input",
              (e) =>
                (newProduct.images = [{ path: e.target.value, position: 1 }])
            );
          document
            .querySelectorAll(".main-attribute-value")
            .forEach((input) => {
              input.addEventListener("input", (e) => {
                newProduct.attributes[e.target.dataset.attrCode] =
                  e.target.value;
              });
            });
        }

        // Listeners para variaciones
        if (newProduct.has_variation) {
          document
            .getElementById("addVariationBtn")
            ?.addEventListener("click", () => {
              newProduct.variations.push({
                sku: "",
                ean: "",
                name: "",
                images: [
                  {
                    path:
                      "https://placehold.co/600x400/00FF00/FFFFFF.png?text=Variacion" +
                      (newProduct.variations.length + 1),
                    position: 1,
                  },
                ],
                attributes: {},
              });
              renderCreateProductModal(); // Re-render para a√±adir el nuevo bloque de variaci√≥n
            });

          document.querySelectorAll(".remove-variation-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              if (newProduct.variations.length > 1) {
                const indexToRemove = parseInt(e.target.dataset.index);
                newProduct.variations.splice(indexToRemove, 1);
                renderCreateProductModal();
              }
            });
          });

          newProduct.variations.forEach((variation, index) => {
            document
              .getElementById(`varSku_${index}`)
              ?.addEventListener(
                "input",
                (e) => (variation.sku = e.target.value)
              );
            document
              .getElementById(`varName_${index}`)
              ?.addEventListener(
                "input",
                (e) => (variation.name = e.target.value)
              );
            document
              .getElementById(`varEan_${index}`)
              ?.addEventListener(
                "input",
                (e) => (variation.ean = e.target.value)
              );
            document
              .getElementById(`varImgUrl_${index}`)
              ?.addEventListener(
                "input",
                (e) =>
                  (variation.images = [{ path: e.target.value, position: 1 }])
              );
            document
              .querySelectorAll(`.var-attribute-value[data-index="${index}"]`)
              .forEach((input) => {
                input.addEventListener("input", (e) => {
                  variation.attributes[e.target.dataset.attrCode] =
                    e.target.value;
                });
              });
          });
        }

        if (
          categoryTreeData &&
          document.getElementById("categoryTreeContainer")
        ) {
          document
            .getElementById("categoryTreeContainer")
            .querySelectorAll(".category-node")
            .forEach((nodeEl) => {
              nodeEl.addEventListener("click", (ev) => {
                const catId = ev.currentTarget.dataset.id;
                const catName = ev.currentTarget.dataset.name;
                if (catId && catId !== "null") {
                  document.getElementById("newProdCatId").value = catId;
                  newProduct.category_id = catId;
                  showToast(
                    `Categor√≠a principal seleccionada: ${catName} (ID: ${catId})`
                  );
                  availableAttributes = [];
                  renderCreateProductModal();
                  fetchCategoryAttributes(catId, "create");
                }
              });
            });
        }
      }

      function renderEditProductModal() {
        if (!showEditProductModal || !productToEdit) {
          editProductModalEl.innerHTML = "";
          editProductModalEl.classList.remove("active");
          return;
        }

        if (
          editedProductData.category_id &&
          availableAttributes.length === 0 &&
          !isLoadingAttributes
        ) {
          fetchCategoryAttributes(editedProductData.category_id, "edit");
        }

        editProductModalEl.innerHTML = `
                <div class="modal-content">
                     <div class="modal-header"><h3>Editar Producto (ID Rappi Original: ${
                       productToEdit.id
                     })</h3><button id="closeEditModalBtn" class="close-btn">&times;</button></div>
                    <form id="editCatalogProductForm">
                        <p class="text-sm mb-4">Se intentar√° eliminar el producto original de Rappi (ID: ${
                          productToEdit.id
                        }) y se crear√° uno nuevo con los datos modificados. El nuevo producto deber√° ser asociado a las tiendas.</p>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="form-group"><label>ID Rappi (Original):</label><input type="text" class="input-field" value="${
                              productToEdit.id
                            }" disabled></div>
                            <div class="form-group"><label for="editProdSku">SKU:</label><input type="text" id="editProdSku" class="input-field" value="${
                              editedProductData.sku || ""
                            }"></div>
                            <div class="form-group md-col-span-2"><label for="editProdName">Nombre:</label><input type="text" id="editProdName" class="input-field" value="${
                              editedProductData.name || ""
                            }"></div>
                            <div class="form-group md-col-span-2"><label for="editProdDesc">Descripci√≥n:</label><textarea id="editProdDesc" class="input-field">${
                              editedProductData.description || ""
                            }</textarea></div>
                            <div class="form-group"><label for="editProdEan">EAN:</label><input type="text" id="editProdEan" class="input-field" value="${
                              editedProductData.ean || ""
                            }"></div>
                            <div class="form-group"><label for="editProdPresQty">Cant. Presentaci√≥n:</label><input type="number" id="editProdPresQty" class="input-field" value="${
                              editedProductData.presentation_quantity || 1
                            }" min="0.01" step="any"></div>
                            <div class="form-group"><label for="editProdPresUnit">Unidad Presentaci√≥n:</label>
                                <select id="editProdPresUnit" class="input-field">
                                    <option value="Und" ${
                                      editedProductData.presentation_unit_type ===
                                      "Und"
                                        ? "selected"
                                        : ""
                                    }>Und</option> <option value="Kg" ${
          editedProductData.presentation_unit_type === "Kg" ? "selected" : ""
        }>Kg</option>
                                    <option value="g" ${
                                      editedProductData.presentation_unit_type ===
                                      "g"
                                        ? "selected"
                                        : ""
                                    }>g</option> <option value="mg" ${
          editedProductData.presentation_unit_type === "mg" ? "selected" : ""
        }>mg</option>
                                    <option value="L" ${
                                      editedProductData.presentation_unit_type ===
                                      "L"
                                        ? "selected"
                                        : ""
                                    }>L</option> <option value="mL" ${
          editedProductData.presentation_unit_type === "mL" ? "selected" : ""
        }>mL</option>
                                </select>
                            </div>
                            <div class="form-group md-col-span-2"><label for="editProdImgUrl">URL Imagen:</label><input type="text" id="editProdImgUrl" class="input-field" value="${
                              editedProductData.images &&
                              editedProductData.images.length > 0
                                ? editedProductData.images[0].path
                                : ""
                            }">
                                ${
                                  editedProductData.images &&
                                  editedProductData.images.length > 0 &&
                                  editedProductData.images[0].path
                                    ? `<img src="${getRappiImageUrl(
                                        editedProductData.images[0].path
                                      )}" alt="Vista previa" style="max-width: 100px; max-height: 100px; margin-top: 5px; border: 1px solid #ccc;"/>`
                                    : ""
                                }
                            </div>
                        </div>
                         <div class="form-group mt-4">
                            <label for="editProdCatId">ID Categor√≠a (Rappi): <span class="text-red-500">*</span></label>
                             <div class="flex gap-2 items-center">
                                <input type="text" id="editProdCatId" class="input-field" value="${
                                  editedProductData.category_id || ""
                                }" placeholder="Selecciona del √°rbol o ingresa ID">
                                <button type="button" id="loadCategoryTreeBtnEdit" class="btn btn-secondary text-xs ${
                                  isLoadingCategoryTree ? "opacity-50" : ""
                                }" ${
          isLoadingCategoryTree ? "disabled" : ""
        } style="white-space:nowrap;">${
          isLoadingCategoryTree ? "Cargando..." : "Ver √Årbol"
        }</button>
                                <button type="button" id="loadAttributesBtnEdit" class="btn btn-info text-xs ${
                                  isLoadingAttributes ||
                                  !editedProductData.category_id
                                    ? "opacity-50"
                                    : ""
                                }" ${
          isLoadingAttributes || !editedProductData.category_id
            ? "disabled"
            : ""
        } style="white-space:nowrap;">${
          isLoadingAttributes ? "Cargando..." : "Cargar Atributos"
        }</button>
                            </div>
                            <div id="editCategoryTreeContainer" class="mt-2 scrollable-list text-xs" style="display: ${
                              categoryTreeData ? "block" : "none"
                            };">${
          categoryTreeData ? renderCategoryTreeNode(categoryTreeData) : ""
        }</div>
                        </div>
                        <div class="form-group mt-2">
                            <label>Atributos:</label>
                            <div id="editProdAttributesContainer" class="attributes-container">
                                ${
                                  availableAttributes.length > 0
                                    ? availableAttributes
                                        .map(
                                          (attr) => `
                                    <div class="attribute-item">
                                        <label for="edit_attr_${attr.code}">${
                                            attr.name
                                          } (${attr.code}):</label>
                                        <input type="text" id="edit_attr_${
                                          attr.code
                                        }" class="input-field input-field-sm edit-attribute-value" data-attr-code="${
                                            attr.code
                                          }" value="${
                                            editedProductData.attributes[
                                              attr.code
                                            ] || ""
                                          }">
                                    </div>
                                `
                                        )
                                        .join("")
                                    : '<p class="text-xs">Cargue atributos usando el bot√≥n de arriba si esta categor√≠a los requiere o no hay disponibles.</p>'
                                }
                            </div>
                        </div>
                         <div class="modal-footer">
                            <button type="button" id="cancelEditModalBtn" class="btn btn-secondary">Cancelar</button>
                            <button type="submit" class="btn btn-warning ${
                              isUpdatingCatalogProduct ? "opacity-50" : ""
                            }" ${isUpdatingCatalogProduct ? "disabled" : ""}>${
          isUpdatingCatalogProduct
            ? "Procesando..."
            : "Guardar Cambios (Recrear Producto)"
        }</button>
                        </div>
                    </form>
                </div>`;
        document
          .getElementById("editCatalogProductForm")
          ?.addEventListener("submit", handleEditCatalogProductWorkflow);
        document
          .getElementById("closeEditModalBtn")
          ?.addEventListener("click", closeEditProductModal);
        document
          .getElementById("cancelEditModalBtn")
          ?.addEventListener("click", closeEditProductModal);
        document
          .getElementById("editProdSku")
          .addEventListener(
            "input",
            (e) => (editedProductData.sku = e.target.value)
          );
        document
          .getElementById("editProdName")
          .addEventListener(
            "input",
            (e) => (editedProductData.name = e.target.value)
          );
        document
          .getElementById("editProdDesc")
          .addEventListener(
            "input",
            (e) => (editedProductData.description = e.target.value)
          );
        document
          .getElementById("editProdEan")
          .addEventListener(
            "input",
            (e) => (editedProductData.ean = e.target.value)
          );
        document
          .getElementById("editProdCatId")
          .addEventListener("input", (e) => {
            editedProductData.category_id = e.target.value;
            availableAttributes = [];
            renderEditProductModal();
          });
        document
          .getElementById("editProdPresQty")
          .addEventListener(
            "input",
            (e) => (editedProductData.presentation_quantity = e.target.value)
          );
        document
          .getElementById("editProdPresUnit")
          .addEventListener(
            "change",
            (e) => (editedProductData.presentation_unit_type = e.target.value)
          );
        document
          .getElementById("editProdImgUrl")
          .addEventListener(
            "input",
            (e) =>
              (editedProductData.images = [
                { path: e.target.value, position: 1 },
              ])
          );
        document
          .getElementById("loadCategoryTreeBtnEdit")
          ?.addEventListener("click", () =>
            fetchCategoryTree("editProdCatId", editedProductData, "edit")
          );
        document
          .getElementById("loadAttributesBtnEdit")
          ?.addEventListener("click", () => {
            if (editedProductData.category_id)
              fetchCategoryAttributes(editedProductData.category_id, "edit");
            else
              showToast(
                "Por favor, ingresa o selecciona un ID de categor√≠a primero."
              );
          });
        document.querySelectorAll(".edit-attribute-value").forEach((input) => {
          input.addEventListener("input", (e) => {
            if (!editedProductData.attributes)
              editedProductData.attributes = {};
            editedProductData.attributes[e.target.dataset.attrCode] =
              e.target.value;
          });
        });

        if (
          categoryTreeData &&
          document.getElementById("editCategoryTreeContainer")
        ) {
          document
            .getElementById("editCategoryTreeContainer")
            .querySelectorAll(".category-node")
            .forEach((nodeEl) => {
              nodeEl.addEventListener("click", (ev) => {
                const catId = ev.currentTarget.dataset.id;
                const catName = ev.currentTarget.dataset.name;
                if (catId && catId !== "null") {
                  document.getElementById("editProdCatId").value = catId;
                  editedProductData.category_id = catId;
                  showToast(`Categor√≠a copiada: ${catName} (ID: ${catId})`);
                  availableAttributes = [];
                  renderEditProductModal();
                  fetchCategoryAttributes(catId, "edit");
                }
              });
            });
        }
      }

      function renderDesassociateModal() {
        if (!showDesassociateModal) {
          desassociateModalEl.innerHTML = "";
          desassociateModalEl.classList.remove("active");
          return;
        }
        desassociateModalEl.innerHTML = `
                <div class="modal-content" style="max-width: 450px;">
                    <div class="modal-header"><h3>Desasociar Producto de Tienda</h3><button id="cancelDesassociateBtn" class="close-btn">&times;</button></div>
                    <p class="text-sm mb-2">Producto: <strong>${
                      allCatalogProducts.find(
                        (p) =>
                          p.id.toString() === productToDesassociateId.toString()
                      )?.name || "Desconocido"
                    }</strong> (ID Rappi: ${productToDesassociateId})</p>
                    ${
                      isLoadingStores
                        ? '<p class="text-sm">Cargando tiendas...</p>'
                        : ""
                    }
                    ${
                      !isLoadingStores && storesList.length === 0
                        ? '<p class="text-sm">No hay tiendas.</p>'
                        : ""
                    }
                    ${
                      !isLoadingStores && storesList.length > 0
                        ? `
                        <div class="form-group">
                            <label for="storeToDesassociate">Selecciona la tienda:</label>
                            <select id="storeToDesassociate" class="input-field">
                                <option value="">-- Selecciona una tienda --</option>
                                ${storesList
                                  .map(
                                    (store) =>
                                      `<option value="${store.id}">${store.name} (ID: ${store.id})</option>`
                                  )
                                  .join("")}
                            </select>
                        </div>`
                        : ""
                    }
                    <div class="modal-footer">
                        <button type="button" id="cancelDesassociateBtnModal" class="btn btn-secondary">Cancelar</button>
                        <button type="button" id="confirmDesassociateBtnFinal" class="btn btn-danger ${
                          isDeletingProductFromStore || storesList.length === 0
                            ? "opacity-50"
                            : ""
                        }" ${
          isDeletingProductFromStore || storesList.length === 0
            ? "disabled"
            : ""
        }>
                            ${
                              isDeletingProductFromStore
                                ? "Desasociando..."
                                : "Desasociar"
                            }
                        </button>
                    </div>
                </div>`;
        document
          .getElementById("cancelDesassociateBtn")
          ?.addEventListener("click", closeDesassociateModal);
        document
          .getElementById("cancelDesassociateBtnModal")
          ?.addEventListener("click", closeDesassociateModal);
        document
          .getElementById("confirmDesassociateBtnFinal")
          ?.addEventListener("click", confirmDesassociateProductFromStore);
        const storeSelect = document.getElementById("storeToDesassociate");
        if (storeSelect) {
          storeSelect.addEventListener("change", (e) => {
            storeToDesassociateFromId = e.target.value;
          });
        }
      }

      function renderDeleteCatalogProductModal() {
        if (!showDeleteCatalogProductModal || !productToDeleteFromCatalog) {
          deleteCatalogProductModalEl.innerHTML = "";
          deleteCatalogProductModalEl.classList.remove("active");
          return;
        }
        deleteCatalogProductModalEl.innerHTML = `
                <div class="modal-content" style="max-width: 450px;">
                    <div class="modal-header"><h3>Eliminar Producto del Cat√°logo</h3><button id="cancelDeleteCatalogBtn" class="close-btn">&times;</button></div>
                    <p class="text-sm mb-2">¬øEst√°s seguro de que quieres eliminar <strong>${
                      productToDeleteFromCatalog.name
                    }</strong> (ID Rappi: ${
          productToDeleteFromCatalog.id
        }) del cat√°logo de Rappi?</p>
                    <p class="text-xs mb-4 text-gray-600">Esta acci√≥n intentar√° eliminar el producto de los sistemas de Rappi. Para que deje de aparecer en tiendas, primero debes desasociarlo de cada una.</p>
                    <div class="modal-footer">
                        <button type="button" id="cancelDeleteCatalogModalBtn" class="btn btn-secondary">Cancelar</button>
                        <button type="button" id="confirmDeleteCatalogBtnFinal" class="btn btn-danger ${
                          isDeletingFromCatalog ? "opacity-50" : ""
                        }" ${isDeletingFromCatalog ? "disabled" : ""}>
                            ${
                              isDeletingFromCatalog
                                ? "Eliminando..."
                                : "Eliminar de Rappi"
                            }
                        </button>
                    </div>
                </div>`;
        document
          .getElementById("cancelDeleteCatalogBtn")
          ?.addEventListener("click", closeDeleteCatalogProductModal);
        document
          .getElementById("cancelDeleteCatalogModalBtn")
          ?.addEventListener("click", closeDeleteCatalogProductModal);
        document
          .getElementById("confirmDeleteCatalogBtnFinal")
          ?.addEventListener("click", confirmDeleteProductFromCatalog);
      }

      function renderAssociateModal() {
        if (!showAssociateModal || !productToAssociate) {
          associateModalEl.innerHTML = "";
          associateModalEl.classList.remove("active");
          return;
        }
        associateModalEl.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header"><h3>Asociar/Actualizar "${
                      productToAssociate.name
                    }" (ID: ${
          productToAssociate.id
        })</h3><button id="closeAssociateModalBtn" class="close-btn">&times;</button></div>
                    ${
                      isLoadingStores
                        ? '<p class="text-sm">Cargando tiendas...</p>'
                        : ""
                    }
                    ${
                      !isLoadingStores && storesList.length === 0
                        ? '<p class="text-sm">No hay tiendas.</p>'
                        : ""
                    }
                    ${
                      !isLoadingStores && storesList.length > 0
                        ? `
                        <form id="associateStoresForm">
                            <p class="text-sm mb-2">Selecciona tiendas e ingresa precio regular, precio con descuento (opcional) y stock:</p>
                            <div class="scrollable-list">
                            ${storesList
                              .map(
                                (store) => `
                                <div class="p-2 border-b">
                                    <label class="flex items-center space-x-2 cursor-pointer">
                                        <input type="checkbox" class="store-checkbox" data-store-id="${store.id}">
                                        <span class="text-sm">${store.name} (ID: ${store.id})</span>
                                    </label>
                                    <div class="mt-1 ml-6 grid grid-cols-3 gap-2 store-details" style="display:none;">
                                        <input type="number" class="input-field input-field-sm store-price" placeholder="Precio Regular*" data-store-id="${store.id}" disabled min="0" step="0.01" required>
                                        <input type="number" class="input-field input-field-sm store-sale-price" placeholder="Precio c/Desc. (Opc)" data-store-id="${store.id}" disabled min="0" step="0.01">
                                        <input type="number" class="input-field input-field-sm store-stock" placeholder="Stock*" data-store-id="${store.id}" disabled min="0" step="1" required>
                                    </div>
                                </div>`
                              )
                              .join("")}
                            </div>
                            <div class="modal-footer">
                                <button type="button" id="cancelAssociateModalBtn" class="btn btn-secondary">Cancelar</button>
                                <button type="submit" class="btn btn-primary ${
                                  isAssociatingProduct ? "opacity-50" : ""
                                }" ${isAssociatingProduct ? "disabled" : ""}>${
                            isAssociatingProduct ? "Aplicando..." : "Aplicar"
                          }</button>
                            </div>
                        </form>`
                        : ""
                    }
                </div>`;
        document
          .getElementById("closeAssociateModalBtn")
          ?.addEventListener("click", closeAssociateModal);
        document
          .getElementById("cancelAssociateModalBtn")
          ?.addEventListener("click", closeAssociateModal);
        document
          .getElementById("associateStoresForm")
          ?.addEventListener("submit", handleAssociateProductToStores);
        document.querySelectorAll(".store-checkbox").forEach((checkbox) => {
          checkbox.addEventListener("change", (e) => {
            const detailsDiv = e.target
              .closest("div.p-2")
              .querySelector(".store-details");
            const priceInput = detailsDiv.querySelector(".store-price");
            const stockInput = detailsDiv.querySelector(".store-stock");
            const salePriceInput =
              detailsDiv.querySelector(".store-sale-price");
            if (e.target.checked) {
              detailsDiv.style.display = "grid";
              priceInput.disabled = false;
              stockInput.disabled = false;
              salePriceInput.disabled = false;
            } else {
              detailsDiv.style.display = "none";
              priceInput.disabled = true;
              stockInput.disabled = true;
              salePriceInput.disabled = true;
              priceInput.value = "";
              stockInput.value = "";
              salePriceInput.value = "";
            }
          });
        });
      }

      function renderOrderDetailsAccordionContent(order) {
        if (!order._details || order._isLoadingDetails) {
          return '<p class="text-sm p-2">Cargando detalles...</p>';
        }
        if (order._details.error) {
          return `<div class="alert alert-error p-2">${order._details.error}</div>`;
        }
        const details = order._details;

        const isOrderFinishedOrCanceled =
          details.status === "finished" || details.status === "canceled";

        const disableStartPicking =
          !details.event_uuid ||
          orderActionInProgress ||
          details.status !== "created" ||
          order._pickingStarted;
        const disableReportInvoice =
          !details.event_uuid ||
          orderActionInProgress ||
          order._invoiceReported ||
          (details.status !== "created" &&
            details.status !== "picking_started_by_partner" &&
            !order._pickingStarted) ||
          isOrderFinishedOrCanceled;
        const disableRequestCourier =
          !details.event_uuid ||
          orderActionInProgress ||
          !order._invoiceReported ||
          order._courierAssigned ||
          isOrderFinishedOrCanceled ||
          order._courierRequested;
        const disableStartHandshake =
          !details.event_uuid ||
          orderActionInProgress ||
          !order._invoiceReported ||
          !order._courierAssigned ||
          isOrderFinishedOrCanceled ||
          order._handshakeStarted ||
          order._handshakeCompleted;
        const disableCancelOrder =
          !details.event_uuid ||
          orderActionInProgress ||
          isOrderFinishedOrCanceled;

        let courierInfo = "No asignado";
        if (order._courierAssigned && details.courier) {
          courierInfo = `${details.courier.first_name || ""} ${
            details.courier.last_name || ""
          } (${details.courier.vehicle_type || "N/A"}) - Tel: ${
            details.courier.phone || "N/A"
          }`;
        }

        let substitutionStatusesHtml = "";
        if (
          order._substitutionStatuses &&
          order._substitutionStatuses.length > 0
        ) {
          substitutionStatusesHtml = `<h4>Estado de Sustituciones:</h4><div class="scrollable-list" style="max-height:100px; font-size:0.8em;">`;
          order._substitutionStatuses.forEach((sub) => {
            substitutionStatusesHtml += `
                        <div class="substitution-status-item">
                            <p><strong>Original:</strong> ${
                              sub.original_product?.name || "N/A"
                            } (ID: ${sub.original_product?.id || "N/A"})</p>
                            <p><strong>Sugerido por Tienda:</strong> ${
                              sub.product_suggested_by_partner?.name || "N/A"
                            } (ID: ${
              sub.product_suggested_by_partner?.id || "N/A"
            })</p>
                            ${
                              sub.product_suggested_by_user?.id
                                ? `<p><strong>Sugerido por Usuario:</strong> ${sub.product_suggested_by_user.name} (ID: ${sub.product_suggested_by_user.id})</p>`
                                : ""
                            }
                            <p><strong>Estado Aprobaci√≥n:</strong> ${
                              sub.approval_status || "N/A"
                            }</p>
                        </div>`;
          });
          substitutionStatusesHtml += `</div>`;
        }

        return `
                <div class="order-details-content text-sm space-y-2">
                    <p><strong>Estado:</strong> ${details.status || "N/A"} 
                        ${
                          details.event_uuid
                            ? `(event_uuid: ${details.event_uuid.substring(
                                0,
                                8
                              )}...)`
                            : "(event_uuid no disponible en detalles)"
                        }</p>
                    <p><strong>Cliente:</strong> ${
                      details.client?.first_name || ""
                    } ${details.client?.last_name || ""} (Email: ${
          details.client?.email || "N/A"
        })</p>
                    <p><strong>Total:</strong> ${
                      details.total_price != null
                        ? details.total_price.toFixed(2)
                        : "N/A"
                    }</p>
                    <p><strong>RT Asignado:</strong> ${courierInfo}</p>
                    <p><strong>Fecha Creaci√≥n:</strong> ${
                      details.created_at
                        ? new Date(details.created_at).toLocaleString()
                        : "N/A"
                    }</p>
                    ${
                      details.place_at
                        ? `<p><strong>Fecha Programada:</strong> ${new Date(
                            details.place_at
                          ).toLocaleString()}</p>`
                        : ""
                    }
                    ${
                      details.delivered_at
                        ? `<p><strong>Fecha Entrega:</strong> ${new Date(
                            details.delivered_at
                          ).toLocaleString()}</p>`
                        : ""
                    }
                    <p><strong>Direcci√≥n:</strong> ${
                      details.address?.street_address || ""
                    }, ${details.address?.city || ""}</p>
                    
                    <h4>Productos:</h4>
                    <ul class="list-disc pl-5">
                        ${
                          (details.products || order.products)
                            ?.map(
                              (p) => `
                            <li class="order-product-item">
                                <div>
                                    <span>${p.name} (SKU: ${p.sku}) - Cant: ${
                                p.quantity?.units || p.quantity?.grams || "N/A"
                              } - Precio Unit: ${
                                p.unit_price?.toFixed(2) || "N/A"
                              }</span>
                                    ${
                                      p.user_preference
                                        ? `<br><span class="text-xs text-gray-600">Preferencia Usuario: ${
                                            p.user_preference.action
                                          } ${
                                            p.user_preference.action ===
                                              "user_chooses" &&
                                            p.user_preference.preferred_product
                                              ? `(${p.user_preference.preferred_product.name} - ID: ${p.user_preference.preferred_product.id})`
                                              : ""
                                          }</span>`
                                        : ""
                                    }
                                </div>
                                <div class="table-actions">
                                    <button class="btn-link text-xs substitute-order-product-btn" 
                                            data-order-id="${details.id}" 
                                            data-product-id="${p.id}" 
                                            data-product-name="${p.name}"
                                            data-user-pref-action="${
                                              p.user_preference?.action || ""
                                            }"
                                            data-user-pref-prod-id="${
                                              p.user_preference
                                                ?.preferred_product?.id || ""
                                            }"
                                            data-user-pref-prod-name="${
                                              p.user_preference
                                                ?.preferred_product?.name || ""
                                            }"
                                            ${
                                              orderActionInProgress ||
                                              isOrderFinishedOrCanceled ||
                                              !details.event_uuid ||
                                              details.status ===
                                                "invoice_reported" ||
                                              details.status === "finished" ||
                                              details.status === "canceled"
                                                ? "disabled"
                                                : ""
                                            }>
                                        Sustituir
                                    </button>
                                    <button class="btn-link-danger text-xs remove-order-product-btn" 
                                            data-order-id="${details.id}" 
                                            data-product-id="${p.id}" 
                                            data-product-name="${p.name}"
                                            data-order-product-id="${
                                              p.order_product_id || p.id
                                            }" 
                                            ${
                                              orderActionInProgress ||
                                              isOrderFinishedOrCanceled ||
                                              !details.event_uuid ||
                                              details.status ===
                                                "invoice_reported" ||
                                              details.status === "finished" ||
                                              details.status === "canceled"
                                                ? "disabled"
                                                : ""
                                            }>
                                        Eliminar
                                    </button>
                                </div>
                            </li>`
                            )
                            .join("") || "<li>No hay productos.</li>"
                        }
                    </ul>
                     <div class="mt-2">
                        <button class="btn btn-secondary btn-sm fetch-substitution-status-btn" data-order-id="${
                          details.id
                        }" ${isLoadingSubstitutionStatuses ? "disabled" : ""}>
                            ${
                              isLoadingSubstitutionStatuses
                                ? "Cargando..."
                                : "Ver/Actualizar Estado Sustituciones"
                            }
                        </button>
                        <div id="substitutionStatusContainer_${
                          details.id
                        }" class="mt-2">
                            ${substitutionStatusesHtml}
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t space-x-2">
                        <button class="btn btn-info text-xs start-picking-btn" data-order-id="${
                          details.id
                        }" ${
          disableStartPicking ? "disabled" : ""
        }>Iniciar Picking ${order._pickingStarted ? "(Iniciado)" : ""}</button>
                        <button class="btn btn-success text-xs report-invoice-btn" data-order-id="${
                          details.id
                        }" ${
          disableReportInvoice ? "disabled" : ""
        }>Reportar Factura ${
          order._invoiceReported ? "(Reportada)" : ""
        }</button>
                        <button class="btn btn-primary text-xs request-courier-btn" data-order-id="${
                          details.id
                        }" ${
          disableRequestCourier ? "disabled" : ""
        }>Solicitar RT ${
          order._courierRequested
            ? "(Solicitado)"
            : order._courierAssigned
            ? "(Asignado)"
            : ""
        }</button>
                        <button class="btn btn-warning text-xs start-handshake-btn" data-order-id="${
                          details.id
                        }" ${
          disableStartHandshake ? "disabled" : ""
        }>Iniciar Handshake ${
          order._handshakeStarted
            ? order._handshakeCompleted
              ? "(Completado)"
              : "(Iniciado)"
            : ""
        }</button>
                        <button class="btn btn-danger text-xs cancel-order-btn" data-order-id="${
                          details.id
                        }" ${
          disableCancelOrder ? "disabled" : ""
        }>Cancelar Pedido</button>
                    </div>
                    ${
                      orderActionInProgress &&
                      order._details?.id.toString() === details.id.toString()
                        ? '<p class="text-xs text-blue-600 mt-2">Procesando acci√≥n...</p>'
                        : ""
                    }
                </div>
            `;
      }

      function renderStoresListModal() {
        if (!showStoresListModal) {
          storesListModalEl.innerHTML = "";
          storesListModalEl.classList.remove("active");
          return;
        }
        storesListModalEl.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header"><h3>Lista de Tiendas</h3><button id="closeStoresListModalBtn" class="close-btn">&times;</button></div>
                    ${
                      isLoadingStores
                        ? '<p class="text-sm">Cargando tiendas...</p>'
                        : ""
                    }
                    ${
                      !isLoadingStores && storesList.length === 0
                        ? '<p class="text-sm">No hay tiendas para mostrar.</p>'
                        : ""
                    }
                    ${
                      !isLoadingStores && storesList.length > 0
                        ? `
                        <div class="scrollable-list">
                            <ul>
                                ${storesList
                                  .map(
                                    (
                                      store
                                    ) => `<li class="text-sm p-1 border-b">
                                    ${
                                      store.name
                                    } (ID: <span class="store-list-item-id" title="Copiar ID ${
                                      store.id
                                    }">${store.id}</span>) - ${
                                      store.address || "Direcci√≥n no disponible"
                                    }
                                </li>`
                                  )
                                  .join("")}
                            </ul>
                        </div>
                    `
                        : ""
                    }
                    <div class="modal-footer">
                        <button type="button" id="cancelStoresListModalBtn" class="btn btn-secondary">Cerrar</button>
                    </div>
                </div>`;
        document
          .getElementById("closeStoresListModalBtn")
          ?.addEventListener("click", closeStoresListModal);
        document
          .getElementById("cancelStoresListModalBtn")
          ?.addEventListener("click", closeStoresListModal);
        storesListModalEl
          .querySelectorAll(".store-list-item-id")
          .forEach((el) => {
            el.addEventListener("click", (e) => {
              const idToCopy = e.target.textContent;
              copyToClipboard(idToCopy, `ID de tienda ${idToCopy}`);
            });
          });
      }

      function renderRequestCourierModal() {
        if (!showRequestCourierModal || !orderToRequestCourier) {
          requestCourierModalEl.innerHTML = "";
          requestCourierModalEl.classList.remove("active");
          return;
        }
        const physicalStoreId =
          orderToRequestCourier.store?.physical_store_id ||
          orderToRequestCourier.store?.id ||
          "N/A"; // Usar physical_store_id si existe, sino store.id
        requestCourierModalEl.innerHTML = `
                <div class="modal-content" style="max-width:450px;">
                    <div class="modal-header"><h3>Solicitar RappiTendero</h3><button id="closeRequestCourierModalBtn" class="close-btn">&times;</button></div>
                    <p class="text-sm mb-2">Pedido ID: <strong>${
                      orderToRequestCourier.id
                    }</strong></p>
                    <p class="text-sm mb-2">Tienda ID (para API): <strong>${
                      orderToRequestCourier.store?.id || "N/A"
                    }</strong></p>
                    <div class="form-group">
                        <label for="vehicleTypeSelect">Tipo de Veh√≠culo:</label>
                        <select id="vehicleTypeSelect" class="input-field">
                            <option value="motorbike" ${
                              selectedVehicleTypeForCourier === "motorbike"
                                ? "selected"
                                : ""
                            }>Moto (motorbike)</option>
                            <option value="car" ${
                              selectedVehicleTypeForCourier === "car"
                                ? "selected"
                                : ""
                            }>Auto (car)</option>
                            <option value="bicycle" ${
                              selectedVehicleTypeForCourier === "bicycle"
                                ? "selected"
                                : ""
                            }>Bicicleta (bicycle)</option>
                        </select>
                    </div>
                    <div class="modal-footer">
                        <button type="button" id="cancelRequestCourierModalBtn" class="btn btn-secondary">Cancelar</button>
                        <button type="button" id="confirmRequestCourierBtn" class="btn btn-primary ${
                          isRequestingCourier ? "opacity-50" : ""
                        }" ${isRequestingCourier ? "disabled" : ""}>
                            ${
                              isRequestingCourier
                                ? "Solicitando..."
                                : "Confirmar Solicitud"
                            }
                        </button>
                    </div>
                </div>
            `;
        document
          .getElementById("closeRequestCourierModalBtn")
          ?.addEventListener("click", closeRequestCourierModal);
        document
          .getElementById("cancelRequestCourierModalBtn")
          ?.addEventListener("click", closeRequestCourierModal);
        document
          .getElementById("confirmRequestCourierBtn")
          ?.addEventListener("click", handleRequestCourierConfirm);
        document
          .getElementById("vehicleTypeSelect")
          .addEventListener(
            "change",
            (e) => (selectedVehicleTypeForCourier = e.target.value)
          );
      }

      function renderHandshakeModal() {
        if (!showHandshakeModal || !orderForHandshake) {
          handshakeModalEl.innerHTML = "";
          handshakeModalEl.classList.remove("active");
          return;
        }
        handshakeModalEl.innerHTML = `
                <div class="modal-content" style="max-width:500px;">
                    <div class="modal-header"><h3>Handshake con RT</h3><button id="closeHandshakeModalBtn" class="close-btn">&times;</button></div>
                    <p class="text-sm mb-2">Pedido ID: <strong>${
                      orderForHandshake.id
                    }</strong></p>
                    ${
                      handshakeMessage
                        ? `<div class="alert ${
                            handshakeMessage.toLowerCase().includes("error") ||
                            handshakeMessage.toLowerCase().includes("inv√°lido")
                              ? "alert-error"
                              : handshakeMessage
                                  .toLowerCase()
                                  .includes("exitosamente") ||
                                handshakeMessage
                                  .toLowerCase()
                                  .includes("obtenidos")
                              ? "alert-success"
                              : "alert-info"
                          } mb-2">${handshakeMessage}</div>`
                        : ""
                    }
                    
                    ${
                      handshakeCodes.length === 0
                        ? `
                        <button id="requestHandshakeCodesBtnApi" class="btn btn-primary w-full ${
                          isRequestingHandshakeCodes ? "opacity-50" : ""
                        }" ${isRequestingHandshakeCodes ? "disabled" : ""}>
                            ${
                              isRequestingHandshakeCodes
                                ? "Obteniendo C√≥digos..."
                                : "1. Obtener C√≥digos de Handshake"
                            }
                        </button>
                    `
                        : `
                        <div class="mb-4">
                            <p class="text-sm"><strong>C√≥digos para el RT (solo uno es v√°lido):</strong></p>
                            <div class="flex space-x-2 mt-1">
                                ${handshakeCodes
                                  .map(
                                    (code) =>
                                      `<span class="p-2 bg-gray-100 rounded text-lg font-mono">${code}</span>`
                                  )
                                  .join("")}
                            </div>
                            ${
                              handshakeExpiresAt
                                ? `<p class="text-xs text-gray-500 mt-1">Expiran: ${handshakeExpiresAt}</p>`
                                : ""
                            }
                        </div>
                        <div class="form-group">
                            <label for="rtProvidedCode">2. Ingresa el c√≥digo que te dio el RT:</label>
                            <input type="text" id="rtProvidedCode" class="input-field" value="${codeToValidateByRT}" placeholder="Ej: 123456">
                        </div>
                        <button id="validateHandshakeCodeBtnApi" class="btn btn-success w-full ${
                          isValidatingHandshakeCode ? "opacity-50" : ""
                        }" ${isValidatingHandshakeCode ? "disabled" : ""}>
                            ${
                              isValidatingHandshakeCode
                                ? "Validando..."
                                : "3. Validar C√≥digo del RT"
                            }
                        </button>
                    `
                    }
                    <div class="modal-footer">
                        <button type="button" id="cancelHandshakeModalBtn" class="btn btn-secondary">Cerrar</button>
                    </div>
                </div>
            `;
        document
          .getElementById("closeHandshakeModalBtn")
          ?.addEventListener("click", closeHandshakeModal);
        document
          .getElementById("cancelHandshakeModalBtn")
          ?.addEventListener("click", closeHandshakeModal);
        document
          .getElementById("requestHandshakeCodesBtnApi")
          ?.addEventListener("click", handleRequestHandshakeCodes);
        const rtCodeInput = document.getElementById("rtProvidedCode");
        if (rtCodeInput) {
          rtCodeInput.addEventListener(
            "input",
            (e) => (codeToValidateByRT = e.target.value)
          );
        }
        document
          .getElementById("validateHandshakeCodeBtnApi")
          ?.addEventListener("click", handleValidateHandshakeCode);
      }

      function renderConfirmRemoveProductModal() {
        if (!showRemoveProductModal || !orderProductToRemove) {
          confirmRemoveProductModalEl.innerHTML = "";
          confirmRemoveProductModalEl.classList.remove("active");
          return;
        }
        confirmRemoveProductModalEl.innerHTML = `
                <div class="modal-content" style="max-width:450px;">
                    <div class="modal-header"><h3>Eliminar Producto del Pedido</h3><button id="closeRemoveProductModalBtn" class="close-btn">&times;</button></div>
                    <p class="text-sm mb-4">¬øEst√°s seguro de que quieres eliminar el producto "<strong>${
                      orderProductToRemove.productName
                    }</strong>" (ID en pedido: ${
          orderProductToRemove.productId
        }) del pedido <strong>${orderProductToRemove.orderId}</strong>?</p>
                    <p class="text-xs text-gray-600 mb-2">Esta acci√≥n intentar√° eliminar el producto de este pedido espec√≠fico. Esto es una cancelaci√≥n parcial.</p>
                    <div class="modal-footer">
                        <button type="button" id="cancelRemoveProductModalBtn" class="btn btn-secondary">Cancelar</button>
                        <button type="button" id="confirmRemoveProductBtnFinal" class="btn btn-danger ${
                          isRemovingProductFromOrder ? "opacity-50" : ""
                        }" ${isRemovingProductFromOrder ? "disabled" : ""}>
                            ${
                              isRemovingProductFromOrder
                                ? "Eliminando..."
                                : "Confirmar Eliminaci√≥n"
                            }
                        </button>
                    </div>
                </div>
            `;
        document
          .getElementById("closeRemoveProductModalBtn")
          ?.addEventListener("click", closeConfirmRemoveProductModal);
        document
          .getElementById("cancelRemoveProductModalBtn")
          ?.addEventListener("click", closeConfirmRemoveProductModal);
        document
          .getElementById("confirmRemoveProductBtnFinal")
          ?.addEventListener("click", confirmRemoveProductFromOrder);
      }

      function renderSubstituteProductModal() {
        if (
          !showSubstituteModal ||
          !orderForSubstitution ||
          !productToSubstituteDetails
        ) {
          substituteProductModalEl.innerHTML = "";
          substituteProductModalEl.classList.remove("active");
          return;
        }

        const userPref = productToSubstituteDetails.userPreference;
        let preferenceText = "El usuario no especific√≥ preferencia.";
        if (userPref) {
          if (userPref.action === "refund")
            preferenceText =
              "Usuario prefiere REEMBOLSO si este producto no est√° disponible.";
          else if (userPref.action === "shopper_chooses")
            preferenceText =
              "Usuario permite que la TIENDA ELIJA un sustituto.";
          else if (
            userPref.action === "user_chooses" &&
            userPref.preferred_product
          ) {
            preferenceText = `Usuario prefiere: ${userPref.preferred_product.name} (ID: ${userPref.preferred_product.id})`;
          }
        }

        let searchResultsHtml =
          '<p class="text-xs mt-2">Busca en el cat√°logo para seleccionar un sustituto.</p>';
        if (substituteCatalogSearchResults.length > 0) {
          searchResultsHtml = substituteCatalogSearchResults
            .map(
              (p) => `
                    <div class="substitute-product-search-result-item" data-product-id="${
                      p.id
                    }" data-product-name="${p.name}">
                        <img src="${getRappiImageUrl(
                          p.images && p.images.length > 0
                            ? p.images[0].path
                            : ""
                        )}" alt="${
                p.name
              }" onerror="this.src='https://placehold.co/40x40/cccccc/969696.png?text=NoImg'; this.onerror=null;">
                        <div>
                            <p class="text-sm font-medium">${p.name}</p>
                            <p class="text-xs text-gray-500">SKU: ${
                              p.sku
                            } | ID: ${p.id}</p>
                        </div>
                    </div>
                `
            )
            .join("");
        } else if (substituteCatalogSearchTerm) {
          searchResultsHtml =
            '<p class="text-xs mt-2">No se encontraron productos con ese t√©rmino.</p>';
        }

        substituteProductModalEl.innerHTML = `
                <div class="modal-content" style="max-width:700px;">
                    <div class="modal-header"><h3>Sustituir Producto</h3><button id="closeSubstituteModalBtn" class="close-btn">&times;</button></div>
                    <p class="text-sm mb-1">Pedido ID: <strong>${
                      orderForSubstitution.id
                    }</strong></p>
                    <p class="text-sm mb-2">Producto Original: <strong>${
                      productToSubstituteDetails.originalProductName
                    }</strong> (ID: ${
          productToSubstituteDetails.originalProductId
        })</p>
                    <p class="text-xs text-gray-600 mb-3"><em>${preferenceText}</em></p>
                    
                    <div class="form-group">
                        <label for="substituteCatalogSearchInput">Buscar Sustituto en Cat√°logo:</label>
                        <div class="search-input-group">
                            <input type="text" id="substituteCatalogSearchInput" class="input-field" placeholder="Nombre o SKU del sustituto..." value="${substituteCatalogSearchTerm}">
                            <button type="button" id="searchSubstituteBtn" class="btn btn-secondary text-sm">Buscar</button>
                        </div>
                        <div id="substituteSearchResultsContainer" class="scrollable-list mt-2" style="max-height: 150px;">
                            ${searchResultsHtml}
                        </div>
                    </div>

                    <form id="substituteProductForm">
                        <div class="form-group">
                            <label for="substituteProductId">ID del Producto Sustituto (Rappi ID): <span class="text-red-500">*</span></label>
                            <input type="text" id="substituteProductId" class="input-field" value="${
                              substituteProductData.id
                            }">
                            <p id="substituteProductNameDisplay" class="text-xs text-gray-500 mt-1"></p>
                        </div>
                        <div class="form-group">
                            <label for="substituteProductUnits">Unidades del Sustituto: <span class="text-red-500">*</span></label>
                            <input type="number" id="substituteProductUnits" class="input-field" value="${
                              substituteProductData.units
                            }" min="1">
                        </div>
                         <div class="form-group">
                            <label for="substituteProductWeight">Peso en gramos (si aplica, ej: 250):</label>
                            <input type="number" id="substituteProductWeight" class="input-field" value="${
                              substituteProductData.weight_units || ""
                            }" min="0" step="any">
                        </div>
                        <div class="modal-footer">
                            <button type="button" id="cancelSubstituteModalBtn" class="btn btn-secondary">Cancelar</button>
                            <button type="submit" class="btn btn-primary ${
                              isInitiatingSubstitution ? "opacity-50" : ""
                            }" ${isInitiatingSubstitution ? "disabled" : ""}>
                                ${
                                  isInitiatingSubstitution
                                    ? "Enviando..."
                                    : "Proponer Sustituci√≥n"
                                }
                            </button>
                        </div>
                    </form>
                </div>
            `;
        document
          .getElementById("closeSubstituteModalBtn")
          ?.addEventListener("click", closeSubstituteModal);
        document
          .getElementById("cancelSubstituteModalBtn")
          ?.addEventListener("click", closeSubstituteModal);
        document
          .getElementById("substituteProductForm")
          ?.addEventListener("submit", (e) => {
            e.preventDefault();
            handleInitiateSubstitution();
          });
        document
          .getElementById("substituteProductId")
          .addEventListener(
            "input",
            (e) => (substituteProductData.id = e.target.value)
          );
        document
          .getElementById("substituteProductUnits")
          .addEventListener(
            "input",
            (e) => (substituteProductData.units = parseInt(e.target.value) || 1)
          );
        document
          .getElementById("substituteProductWeight")
          .addEventListener("input", (e) => {
            const val = parseFloat(e.target.value);
            substituteProductData.weight_units = isNaN(val) ? null : val;
          });
        document
          .getElementById("searchSubstituteBtn")
          ?.addEventListener("click", handleSubstituteCatalogSearch);
        const searchInputEl = document.getElementById(
          "substituteCatalogSearchInput"
        );
        if (searchInputEl) {
          searchInputEl.addEventListener(
            "input",
            handleSubstituteCatalogSearch
          );
          // Intento de re-focus (puede ser imperfecto)
          if (document.activeElement !== searchInputEl) {
            //searchInputEl.focus();
            //const val = searchInputEl.value; // Store current value
            //searchInputEl.value = ''; // Clear and re-set to move cursor to end
            //searchInputEl.value = val;
          }
        }

        document
          .querySelectorAll(".substitute-product-search-result-item")
          .forEach((item) => {
            item.addEventListener("click", () => {
              selectSubstituteProduct(
                item.dataset.productId,
                item.dataset.productName
              );
            });
          });
        if (substituteProductData.id && substituteProductData.name) {
          document.getElementById(
            "substituteProductNameDisplay"
          ).textContent = `Seleccionado: ${substituteProductData.name} (ID: ${substituteProductData.id})`;
        }
      }

      function renderSpecificModal(modalName) {
        if (modalName === "create") renderCreateProductModal();
        else if (modalName === "edit") renderEditProductModal();
        else if (modalName === "desassociate") renderDesassociateModal();
        else if (modalName === "deleteCatalog")
          renderDeleteCatalogProductModal();
        else if (modalName === "associate") renderAssociateModal();
        else if (modalName === "storesList") renderStoresListModal();
        else if (modalName === "requestCourier") renderRequestCourierModal();
        else if (modalName === "handshake") renderHandshakeModal();
        else if (modalName === "removeProduct")
          renderConfirmRemoveProductModal();
        else if (modalName === "substituteProduct")
          renderSubstituteProductModal();
      }

      function renderJsonViewers() {
        const reqEl = document.getElementById("lastRequestBodyJson");
        const resEl = document.getElementById("lastResponseDataJson");
        const urlEl = document.getElementById("lastApiUrlDisplay");
        if (reqEl) reqEl.textContent = lastApiRequestBodyString;
        if (resEl) resEl.textContent = lastApiResponseDataString;
        if (urlEl) urlEl.textContent = lastApiRequestUrlAndMethod;
      }

      function renderAppOnly() {
        const currentGlobalErrorMessage = apiGlobalErrorMessage;
        const currentGlobalSuccessMessage = apiGlobalSuccessMessage;
        const currentGlobalInfoMessage = apiGlobalInfoMessage;

        const sourceListForTotalPages = currentCatalogSearchTerm
          ? allCatalogProducts.filter(
              (p) =>
                (p.sku &&
                  p.sku
                    .toLowerCase()
                    .includes(currentCatalogSearchTerm.toLowerCase())) ||
                (p.name &&
                  p.name
                    .toLowerCase()
                    .includes(currentCatalogSearchTerm.toLowerCase()))
            )
          : allCatalogProducts;
        const totalCatalogPages = Math.ceil(
          sourceListForTotalPages.length / catalogItemsPerPage
        );

        appDiv.innerHTML = `
                <div class="card">
                    <h1>Integraci√≥n API Rappi</h1>
                    <div class="form-group">
                        <label for="country">Pa√≠s:</label>
                        <select id="country" class="input-field">
                            ${Object.keys(countryBaseUrls)
                              .map(
                                (countryCode) =>
                                  `<option value="${countryCode}" ${
                                    selectedCountry === countryCode
                                      ? "selected"
                                      : ""
                                  }>${countryCode}</option>`
                              )
                              .join("")}
                        </select>
                    </div>
                    <div class="form-group"><label for="clientId">Client ID:</label><input type="password" id="clientId" class="input-field" value="${clientId}"></div>
                    <div class="form-group"><label for="clientSecret">Client Secret:</label><input type="password" id="clientSecret" class="input-field" value="${clientSecret}"></div>
                    <button id="loginButton" class="btn btn-primary w-full ${
                      isLoading ? "opacity-50" : ""
                    }" ${isLoading ? "disabled" : ""}>${
          isLoading ? "Autenticando..." : "Autenticar"
        }</button>
                    ${
                      currentGlobalErrorMessage
                        ? `<div class="alert alert-error">${currentGlobalErrorMessage}</div>`
                        : ""
                    }
                    ${
                      currentGlobalSuccessMessage
                        ? `<div class="alert alert-success">${currentGlobalSuccessMessage}</div>`
                        : ""
                    }
                    ${
                      currentGlobalInfoMessage
                        ? `<div class="alert alert-info">${currentGlobalInfoMessage}</div>`
                        : ""
                    }
                </div>

                ${
                  accessToken
                    ? `
                    <div class="card">
                        <div class="flex justify-between items-center">
                            <h2 class="text-xl font-semibold">Token de Acceso</h2>
                            <span class="text-sm text-gray-600" id="tokenTimerDisplay">${
                              tokenTimeRemaining ||
                              "El token usualmente expira a medianoche (hora Colombia)."
                            }</span>
                        </div>
                        <p class="text-xs break-all bg-gray-100 p-2 rounded">${accessToken.substring(
                          0,
                          70
                        )}...</p>
                    </div>

                    <div class="card mt-8">
                        <div class="flex justify-between items-center mb-4">
                            <h2>Gesti√≥n de Cat√°logo</h2>
                            <div class="space-x-2">
                                <button id="fetchCatalogProductsButton" class="btn btn-info text-sm ${
                                  isLoadingProducts ? "opacity-50" : ""
                                }" ${isLoadingProducts ? "disabled" : ""}>${
                        isLoadingProducts ? "Cargando..." : "Cargar Productos"
                      }</button>
                                <button id="openCreateProductModalButton" class="btn btn-success text-sm">Nuevo Producto</button>
                            </div>
                        </div>
                        <div class="search-input-group">
                            <input type="text" id="catalogSearchInput" class="input-field" placeholder="Buscar por SKU o Nombre..." value="${currentCatalogSearchTerm}">
                            <button id="catalogSearchButton" class="btn btn-secondary text-sm">Buscar</button>
                            <button id="clearCatalogSearchButton" class="btn btn-secondary text-sm">Limpiar</button>
                        </div>
                        <div class="flex space-x-2 mb-4">
                            <button id="viewCategoriesButton" class="btn btn-secondary text-sm ${
                              isLoadingCategories ? "opacity-50" : ""
                            }" ${isLoadingCategories ? "disabled" : ""}>${
                        isLoadingCategories
                          ? "Cargando..."
                          : "Ver Categor√≠as Principales"
                      }</button>
                            <button id="openStoresListModalButton" class="btn btn-secondary text-sm ${
                              isLoadingStores ? "opacity-50" : ""
                            }" ${isLoadingStores ? "disabled" : ""}>${
                        isLoadingStores ? "Cargando..." : "Ver Lista de Tiendas"
                      }</button>
                        </div>
                        ${
                          categories.length > 0
                            ? `<div class="scrollable-list bg-gray-50 mb-4"><h4 class="text-md font-semibold">Categor√≠as Principales:</h4><ul class="list-disc list-inside">${categories
                                .map(
                                  (cat) =>
                                    `<li class="text-xs">${cat.name} (ID: ${cat.id})</li>`
                                )
                                .join("")}</ul></div>`
                            : ""
                        }
                        
                        <h3>Productos del Cat√°logo:</h3>
                        ${
                          isLoadingProducts
                            ? '<p class="text-sm">Cargando productos...</p>'
                            : ""
                        }
                        ${
                          !isLoadingProducts && productsToDisplay.length > 0
                            ? `
                            <div class="table-wrapper">
                                <table class="table">
                                    <thead><tr><th>SKU</th><th>Nombre</th><th>ID Rappi</th><th>Acciones</th></tr></thead>
                                    <tbody>
                                        ${productsToDisplay
                                          .map(
                                            (p) => `
                                            <tr>
                                                <td>${p.sku}</td><td>${
                                              p.name
                                            }</td><td>${p.id || "N/A"}</td>
                                                <td class="table-actions">
                                                    <button class="btn-link edit-product-btn" data-id="${
                                                      p.id
                                                    }">Editar</button>
                                                    <button class="btn-link associate-store-btn" data-id="${
                                                      p.id
                                                    }">Asociar</button>
                                                    <button class="btn-link desassociate-store-btn" data-id="${
                                                      p.id
                                                    }">Desasociar</button>
                                                    <button class="btn-link-danger delete-catalog-product-btn" data-id="${
                                                      p.id
                                                    }">Eliminar Cat√°logo</button>
                                                </td></tr>`
                                          )
                                          .join("")}
                                    </tbody>
                                </table>
                            </div>
                            <div class="pagination-controls">
                                <button id="prevCatalogPageBtn" class="btn btn-secondary" ${
                                  currentCatalogPage === 1 ? "disabled" : ""
                                }>Anterior</button>
                                <span>P√°gina ${currentCatalogPage} de ${totalCatalogPages} (${
                                sourceListForTotalPages.length
                              } productos)</span>
                                <button id="nextCatalogPageBtn" class="btn btn-secondary" ${
                                  currentCatalogPage === totalCatalogPages ||
                                  totalCatalogPages === 0
                                    ? "disabled"
                                    : ""
                                }>Siguiente</button>
                            </div>
                        `
                            : !isLoadingProducts
                            ? `<p class="text-sm">${
                                currentCatalogSearchTerm
                                  ? "No hay productos que coincidan con la b√∫squeda."
                                  : "No hay productos cargados."
                              }</p>`
                            : ""
                        }
                    </div>

                    <div class="card mt-8">
                        <div class="flex justify-between items-center mb-4">
                            <h2>Gesti√≥n de Pedidos</h2>
                            <div class="flex items-center space-x-2">
                                <select id="pollingFrequencySelect" class="input-field" style="width: auto;">
                                     <option value="5000"  ${
                                       pollingFrequency === 5000
                                         ? "selected"
                                         : ""
                                     }>Cada 5 seg</option>
                                    <option value="30000" ${
                                      pollingFrequency === 30000
                                        ? "selected"
                                        : ""
                                    }>Cada 30 seg</option>
                                    <option value="60000" ${
                                      pollingFrequency === 60000
                                        ? "selected"
                                        : ""
                                    }>Cada 1 min</option>
                                    <option value="120000" ${
                                      pollingFrequency === 120000
                                        ? "selected"
                                        : ""
                                    }>Cada 2 min</option>
                                    <option value="300000" ${
                                      pollingFrequency === 300000
                                        ? "selected"
                                        : ""
                                    }>Cada 5 min</option>
                                </select>
                                <button id="togglePollingButton" class="btn ${
                                  isPollingActive ? "btn-danger" : "btn-success"
                                } text-sm">
                                    ${
                                      isPollingActive
                                        ? "Detener Polling"
                                        : "Iniciar Polling"
                                    }
                                </button>
                            </div>
                        </div>
                        <div class="search-input-group">
                            <input type="text" id="orderSearchInput" class="input-field" placeholder="Buscar por ID de Pedido..." value="${currentOrderSearchTerm}">
                            <button id="orderSearchButton" class="btn btn-secondary text-sm">Buscar Pedido</button>
                            <button id="clearOrderSearchButton" class="btn btn-secondary text-sm">Limpiar B√∫squeda</button>
                        </div>
                        <p class="text-xs text-gray-500 mb-1">Polling: ${
                          isPollingActive
                            ? `Activo (<span id="pollingCountdown">Pr√≥ximo refresco en: ${Math.ceil(
                                timeToNextPoll / 1000
                              )} seg.</span>)`
                            : "Inactivo"
                        }. L√≠mite Rappi: 100 req/min.</p>
                        <p class="text-xs text-gray-500 mb-2">Nota: El polling consulta peri√≥dicamente las √≥rdenes. Las √≥rdenes nuevas o actualizadas pueden tardar unos segundos/minutos en reflejarse seg√∫n la frecuencia seleccionada. Rappi usualmente muestra las √≥rdenes pendientes que requieren acci√≥n. Las √≥rdenes procesadas o muy antiguas podr√≠an no aparecer aqu√≠.</p>
                        <button id="fetchOrdersButton" class="btn btn-info text-sm ${
                          isLoadingOrders ? "opacity-50" : ""
                        }" ${
                        isLoadingOrders || isPollingActive ? "disabled" : ""
                      }>${
                        isLoadingOrders
                          ? "Cargando..."
                          : "Cargar Pedidos (Manual)"
                      }</button>
                        
                        ${
                          isLoadingOrders && !isPollingActive
                            ? '<p class="text-sm">Cargando pedidos...</p>'
                            : ""
                        }
                        ${
                          !isLoadingOrders && displayedOrders.length > 0
                            ? `
                            <div class="table-wrapper mt-4">
                                <table class="table" id="ordersTable">
                                    <thead><tr><th>ID Pedido</th><th>Estado</th><th>Cliente</th><th>Total</th><th>Fecha Creaci√≥n</th><th>Acciones</th></tr></thead>
                                    <tbody>
                                        ${displayedOrders
                                          .map(
                                            (o) => `
                                            <tr class="order-row" data-order-id="${
                                              o.id
                                            }">
                                                <td>${o.id}</td><td>${
                                              o.status
                                            }</td>
                                                <td>${
                                                  o.client?.first_name || ""
                                                } ${
                                              o.client?.last_name || ""
                                            }</td>
                                                <td>${
                                                  o.total_price != null
                                                    ? o.total_price.toFixed(2)
                                                    : "N/A"
                                                }</td>
                                                <td>${
                                                  o.created_at
                                                    ? new Date(
                                                        o.created_at
                                                      ).toLocaleString()
                                                    : "N/A"
                                                }</td>
                                                <td class="table-actions"><button class="btn-link view-order-details-btn" data-order-id="${
                                                  o.id
                                                }">${
                                              o._showDetails
                                                ? "Ocultar Detalles"
                                                : "Ver Detalles"
                                            }</button></td>
                                            </tr>
                                            <tr class="order-details-accordion" id="details-for-order-${
                                              o.id
                                            }" style="display: ${
                                              o._showDetails
                                                ? "table-row"
                                                : "none"
                                            };">
                                                <td colspan="6" class="order-details-row">
                                                    ${
                                                      o._showDetails
                                                        ? renderOrderDetailsAccordionContent(
                                                            o
                                                          )
                                                        : ""
                                                    }
                                                </td>
                                            </tr>
                                        `
                                          )
                                          .join("")}
                                    </tbody>
                                </table>
                            </div>
                        `
                            : !isLoadingOrders
                            ? `<p class="text-sm mt-4">${
                                currentOrderSearchTerm
                                  ? "No hay pedidos que coincidan con la b√∫squeda."
                                  : "No hay pedidos para mostrar."
                              }</p>`
                            : ""
                        }
                    </div>
                `
                    : ""
                }
            `;
        attachAppEventListeners();
      }

      function render() {
        renderAppOnly();
        if (showCreateProductModal) renderCreateProductModal();
        else createProductModalEl.classList.remove("active");
        if (showEditProductModal) renderEditProductModal();
        else editProductModalEl.classList.remove("active");
        if (showDesassociateModal) renderDesassociateModal();
        else desassociateModalEl.classList.remove("active");
        if (showDeleteCatalogProductModal) renderDeleteCatalogProductModal();
        else deleteCatalogProductModalEl.classList.remove("active");
        if (showAssociateModal) renderAssociateModal();
        else associateModalEl.classList.remove("active");
        if (showStoresListModal) renderStoresListModal();
        else storesListModalEl.classList.remove("active");
        if (showRequestCourierModal) renderRequestCourierModal();
        else requestCourierModalEl.classList.remove("active");
        if (showHandshakeModal) renderHandshakeModal();
        else handshakeModalEl.classList.remove("active");
        if (showRemoveProductModal) renderConfirmRemoveProductModal();
        else confirmRemoveProductModalEl.classList.remove("active");
        if (showSubstituteModal) renderSubstituteProductModal();
        else substituteProductModalEl.classList.remove("active");
      }

      function attachAppEventListeners() {
        document.getElementById("country")?.addEventListener("change", (e) => {
          selectedCountry = e.target.value;
        });
        document.getElementById("clientId")?.addEventListener("input", (e) => {
          clientId = e.target.value;
        });
        document
          .getElementById("clientSecret")
          ?.addEventListener("input", (e) => {
            clientSecret = e.target.value;
          });
        document
          .getElementById("loginButton")
          ?.addEventListener("click", handleLogin);

        document
          .getElementById("copyApiUrlBtn")
          ?.addEventListener("click", () =>
            copyToClipboard(lastApiRequestUrlAndMethod, "URL y M√©todo")
          );
        document
          .getElementById("copyApiRequestBodyBtn")
          ?.addEventListener("click", () =>
            copyToClipboard(lastApiRequestBodyString, "Cuerpo de Solicitud")
          );
        document
          .getElementById("copyApiResponseBtn")
          ?.addEventListener("click", () =>
            copyToClipboard(lastApiResponseDataString, "Respuesta API")
          );

        if (accessToken) {
          document
            .getElementById("viewCategoriesButton")
            ?.addEventListener("click", handleViewCategories);
          document
            .getElementById("fetchCatalogProductsButton")
            ?.addEventListener("click", fetchCatalogProducts);
          document
            .getElementById("openCreateProductModalButton")
            ?.addEventListener("click", openCreateProductModal);
          document
            .getElementById("openStoresListModalButton")
            ?.addEventListener("click", openStoresListModal);

          document
            .getElementById("catalogSearchButton")
            ?.addEventListener("click", handleCatalogSearch);
          document
            .getElementById("clearCatalogSearchButton")
            ?.addEventListener("click", clearCatalogSearch);
          document
            .getElementById("prevCatalogPageBtn")
            ?.addEventListener("click", handlePreviousCatalogPage);
          document
            .getElementById("nextCatalogPageBtn")
            ?.addEventListener("click", handleNextCatalogPage);

          document
            .querySelectorAll(".edit-product-btn")
            .forEach((btn) =>
              btn.addEventListener("click", (e) =>
                openEditProductModal(e.target.dataset.id)
              )
            );
          document
            .querySelectorAll(".desassociate-store-btn")
            .forEach((btn) =>
              btn.addEventListener("click", (e) =>
                openDesassociateModal(e.target.dataset.id)
              )
            );
          document
            .querySelectorAll(".associate-store-btn")
            .forEach((btn) =>
              btn.addEventListener("click", (e) =>
                openAssociateModal(e.target.dataset.id)
              )
            );
          document
            .querySelectorAll(".delete-catalog-product-btn")
            .forEach((btn) =>
              btn.addEventListener("click", (e) =>
                openDeleteCatalogProductModal(e.target.dataset.id)
              )
            );

          document
            .getElementById("fetchOrdersButton")
            ?.addEventListener("click", fetchOrders);
          document
            .getElementById("togglePollingButton")
            ?.addEventListener("click", () => {
              if (isPollingActive) stopPolling();
              else startPolling();
            });
          document
            .getElementById("pollingFrequencySelect")
            ?.addEventListener("change", (e) => {
              pollingFrequency = parseInt(e.target.value);
              if (isPollingActive) {
                stopPolling();
                startPolling();
              }
            });
          document
            .getElementById("orderSearchButton")
            ?.addEventListener("click", handleOrderSearch);
          document
            .getElementById("clearOrderSearchButton")
            ?.addEventListener("click", clearOrderSearch);

          document
            .querySelectorAll(".view-order-details-btn")
            .forEach((btn) =>
              btn.addEventListener("click", (e) =>
                toggleOrderDetails(e.target.dataset.orderId)
              )
            );

          const ordersTable = document.getElementById("ordersTable");
          if (ordersTable) {
            ordersTable.addEventListener("click", async (e) => {
              const target = e.target;
              let orderId = target.dataset.orderId;

              if (
                target.classList.contains("remove-order-product-btn") ||
                target.classList.contains("substitute-order-product-btn") ||
                target.classList.contains("fetch-substitution-status-btn")
              ) {
                orderId = target.dataset.orderId;
              } else if (!orderId) {
                return;
              }

              if (target.classList.contains("start-picking-btn")) {
                await startPickingOrder(orderId);
              } else if (target.classList.contains("report-invoice-btn")) {
                await reportOrderInvoice(orderId);
              } else if (target.classList.contains("cancel-order-btn")) {
                await cancelOrder(orderId);
              } else if (target.classList.contains("request-courier-btn")) {
                openRequestCourierModal(orderId);
              } else if (target.classList.contains("start-handshake-btn")) {
                openHandshakeModal(orderId);
              } else if (
                target.classList.contains("remove-order-product-btn")
              ) {
                const productId = target.dataset.productId;
                const productName = target.dataset.productName;
                const orderProductId = target.dataset.orderProductId;
                openConfirmRemoveProductModal(
                  orderId,
                  productId,
                  productName,
                  orderProductId
                );
              } else if (
                target.classList.contains("substitute-order-product-btn")
              ) {
                const productId = target.dataset.productId;
                const productName = target.dataset.productName;
                // La preferencia del usuario se pasa como un string JSON desde el dataset
                const userPrefString = target.dataset.userPrefAction
                  ? JSON.stringify({
                      action: target.dataset.userPrefAction,
                      preferred_product: target.dataset.userPrefProdId
                        ? {
                            id: parseInt(target.dataset.userPrefProdId), // Asegurar que es n√∫mero
                            name: target.dataset.userPrefProdName,
                          }
                        : null,
                    })
                  : null;
                openSubstituteModal(
                  orderId,
                  productId,
                  productName,
                  userPrefString
                );
              } else if (
                target.classList.contains("fetch-substitution-status-btn")
              ) {
                await fetchSubstitutionStatuses(orderId);
              }
            });
          }
        }
      }

      function attachOrderActionListeners(detailsRowSelector) {
        const detailsRow = document.querySelector(detailsRowSelector);
        if (!detailsRow) return;

        detailsRow
          .querySelectorAll(".start-picking-btn")
          .forEach(
            (btn) =>
              (btn.onclick = () => startPickingOrder(btn.dataset.orderId))
          );
        detailsRow
          .querySelectorAll(".report-invoice-btn")
          .forEach(
            (btn) =>
              (btn.onclick = () => reportOrderInvoice(btn.dataset.orderId))
          );
        detailsRow
          .querySelectorAll(".cancel-order-btn")
          .forEach(
            (btn) => (btn.onclick = () => cancelOrder(btn.dataset.orderId))
          );
        detailsRow
          .querySelectorAll(".request-courier-btn")
          .forEach(
            (btn) =>
              (btn.onclick = () => openRequestCourierModal(btn.dataset.orderId))
          );
        detailsRow
          .querySelectorAll(".start-handshake-btn")
          .forEach(
            (btn) =>
              (btn.onclick = () => openHandshakeModal(btn.dataset.orderId))
          );
        detailsRow
          .querySelectorAll(".fetch-substitution-status-btn")
          .forEach(
            (btn) =>
              (btn.onclick = () =>
                fetchSubstitutionStatuses(btn.dataset.orderId))
          );

        detailsRow.querySelectorAll(".remove-order-product-btn").forEach(
          (btn) =>
            (btn.onclick = (e) => {
              const target = e.currentTarget;
              openConfirmRemoveProductModal(
                target.dataset.orderId,
                target.dataset.productId,
                target.dataset.productName,
                target.dataset.orderProductId
              );
            })
        );
        detailsRow.querySelectorAll(".substitute-order-product-btn").forEach(
          (btn) =>
            (btn.onclick = (e) => {
              const target = e.currentTarget;
              const orderId = target.dataset.orderId;
              const productId = target.dataset.productId;
              const productName = target.dataset.productName;
              // Reconstruir el objeto userPreference desde los atributos data-*
              let userPreference = null;
              if (target.dataset.userPrefAction) {
                userPreference = { action: target.dataset.userPrefAction };
                if (
                  target.dataset.userPrefAction === "user_chooses" &&
                  target.dataset.userPrefProdId
                ) {
                  userPreference.preferred_product = {
                    id: parseInt(target.dataset.userPrefProdId),
                    name: target.dataset.userPrefProdName,
                  };
                }
              }
              openSubstituteModal(
                orderId,
                productId,
                productName,
                userPreference
              ); // Pasar el objeto
            })
        );
      }
      render();
    </script>
  </body>
</html>
ÔøΩ
